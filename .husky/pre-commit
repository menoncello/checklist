echo "ğŸ” Scanning for potential secrets..."
# Check for potential secrets (excluding GitHub Actions syntax and test files)
STAGED_FILES=$(git diff --staged --name-only | grep -v '.github/workflows' | grep -v '.test.ts' | grep -v 'stories/' || true)
if [ -n "$STAGED_FILES" ]; then
  if echo "$STAGED_FILES" | xargs grep -E 'api[_-]?key\s*=\s*["'"'"'][^"'"'"']{20,}|secret\s*=\s*["'"'"'][^"'"'"']{20,}|token\s*=\s*["'"'"'][^"'"'"']{20,}|password\s*=\s*["'"'"'][^"'"'"']{8,}|AKIA[0-9A-Z]{16}' 2>/dev/null; then
    echo "âŒ Potential secrets detected! Please remove sensitive data before committing."
    exit 1
  fi
fi

# Run linting
echo "ğŸ¨ Running linting..."
bun run lint

# Run format check
echo "ğŸ“ Checking code formatting..."
bun run format:check

# Run type checking
echo "ğŸ”§ Running type checking..."
bun run typecheck

# Run quality checks
echo "âœ¨ Running quality checks..."
bun run quality

# Run tests on changed files
echo "ğŸ§ª Running tests..."
# Temporarily simplified due to EAGAIN issue with bun test in hooks
# TODO: Investigate and fix the EAGAIN error with bun test --changed
# For now, just run a basic test check to ensure tests compile
bun test --dry-run 2>/dev/null || {
  echo "âŒ Test compilation failed"
  exit 1
}
echo "âœ… Tests validated (dry run)"

# Security audit
echo "ğŸ”’ Running security audit..."
bun audit --audit-level moderate