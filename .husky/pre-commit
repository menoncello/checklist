echo "🔍 Scanning for potential secrets..."
# Check for potential secrets (excluding GitHub Actions syntax and test files)
STAGED_FILES=$(git diff --staged --name-only | grep -v '.github/workflows' | grep -v '.test.ts' | grep -v 'stories/' || true)
if [ -n "$STAGED_FILES" ]; then
  if echo "$STAGED_FILES" | xargs grep -E 'api[_-]?key\s*=\s*["'"'"'][^"'"'"']{20,}|secret\s*=\s*["'"'"'][^"'"'"']{20,}|token\s*=\s*["'"'"'][^"'"'"']{20,}|password\s*=\s*["'"'"'][^"'"'"']{8,}|AKIA[0-9A-Z]{16}' 2>/dev/null; then
    echo "❌ Potential secrets detected! Please remove sensitive data before committing."
    exit 1
  fi
fi

# Get list of staged files for targeted processing
STAGED_TS_FILES=$(git diff --staged --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
STAGED_ALL_FILES=$(git diff --staged --name-only --diff-filter=ACM || true)

if [ -n "$STAGED_ALL_FILES" ]; then
  echo "🎨 Running lint-staged (processing only changed files)..."
  bunx lint-staged

  # Run type checking only if TypeScript files changed
  if [ -n "$STAGED_TS_FILES" ]; then
    echo "🔧 Running type checking..."
    bun run typecheck
  else
    echo "⏭️  Skipping type checking (no TypeScript files changed)"
  fi
else
  echo "⏭️  No staged files to process"
fi

# Run tests on changed files
if [ -n "$STAGED_TS_FILES" ]; then
  echo "🧪 Running tests on changed files..."
  # Get related test files for changed source files
  TEST_FILES=""
  for file in $STAGED_TS_FILES; do
    if [[ "$file" == *.test.ts ]]; then
      TEST_FILES="$TEST_FILES $file"
    else
      # Look for corresponding test file
      test_file="${file%.ts}.test.ts"
      if [ -f "$test_file" ]; then
        TEST_FILES="$TEST_FILES $test_file"
      fi
    fi
  done

  if [ -n "$TEST_FILES" ]; then
    # Run specific test files
    bun test $TEST_FILES --bail || {
      echo "❌ Tests failed for changed files"
      exit 1
    }
  else
    # Fallback to dry run if no specific tests found
    bun test --dry-run 2>/dev/null || {
      echo "❌ Test compilation failed"
      exit 1
    }
    echo "✅ Tests validated (dry run - no specific tests found)"
  fi
else
  echo "⏭️  Skipping tests (no TypeScript files changed)"
fi

# Security audit
echo "🔒 Running security audit..."
bun audit --audit-level moderate