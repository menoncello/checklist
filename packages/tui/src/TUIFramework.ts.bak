import { ComponentRegistry } from './components/ComponentRegistry';
import { DebugIntegration } from './debug';
import { ErrorBoundary } from './errors/ErrorBoundary';
import { EventManager } from './events/EventManager';
import { KeyboardHandler } from './events/KeyboardHandler';
import { ApplicationLoop } from './framework/ApplicationLoop';
import { LifecycleManager } from './framework/Lifecycle';
import { TerminalCanvas } from './framework/TerminalCanvas';
import {
  UIFramework,
  RenderContext,
  Screen,
  Component,
} from './framework/UIFramework';
import { PerformanceManager } from './performance';
import { ScreenManager } from './screens/ScreenManager';
import { CapabilityDetector } from './terminal/CapabilityDetector';

export interface TUIFrameworkConfig {
  // Framework settings
  enableFramework: boolean;
  targetFPS: number;

  // Performance settings
  enablePerformanceMonitoring: boolean;
  performanceTargets: {
    startupTime: number;
    renderTime: number;
    memoryLimit: number;
  };

  // Debug settings
  enableDebugMode: boolean;
  debugInProduction: boolean;

  // Error handling
  enableErrorBoundaries: boolean;
  enableCrashRecovery: boolean;

  // Terminal settings
  enableTerminalDetection: boolean;
  fallbackToBasic: boolean;

  // Event handling
  enableKeyboardShortcuts: boolean;
  enableMouseSupport: boolean;
}

export interface TUIFrameworkState {
  isInitialized: boolean;
  isRunning: boolean;
  currentScreen: string | null;
  componentCount: number;
  errorCount: number;
  startupTime: number;
  uptime: number;
}

export class TUIFramework implements UIFramework {
  private config: TUIFrameworkConfig;
  private state: TUIFrameworkState;

  // Core components
  private canvas: TerminalCanvas;
  private applicationLoop: ApplicationLoop;
  private lifecycle: LifecycleManager;
  private screenManager: ScreenManager;
  private componentRegistry: ComponentRegistry;
  private eventManager: EventManager;
  private keyboardHandler: KeyboardHandler;
  private capabilityDetector: CapabilityDetector;
  private errorBoundary: ErrorBoundary;
  private performanceManager: PerformanceManager;
  private debugIntegration: DebugIntegration;

  private eventHandlers = new Map<string, Set<Function>>();
  private isShuttingDown = false;

  constructor(config: Partial<TUIFrameworkConfig> = {}) {
    this.config = {
      enableFramework: true,
      targetFPS: 60,
      enablePerformanceMonitoring: true,
      performanceTargets: {
        startupTime: 100, // 100ms
        renderTime: 16, // 16ms (60 FPS)
        memoryLimit: 50 * 1024 * 1024, // 50MB
      },
      enableDebugMode: process.env.NODE_ENV !== 'production',
      debugInProduction: false,
      enableErrorBoundaries: true,
      enableCrashRecovery: true,
      enableTerminalDetection: true,
      fallbackToBasic: true,
      enableKeyboardShortcuts: true,
      enableMouseSupport: false,
      ...config,
    };

    this.state = {
      isInitialized: false,
      isRunning: false,
      currentScreen: null,
      componentCount: 0,
      errorCount: 0,
      startupTime: 0,
      uptime: 0,
    };

    this.initializeFramework();
  }

  private async initializeFramework(): Promise<void> {
    const startTime = performance.now();

    try {
      // Initialize performance monitoring first
      if (this.config.enablePerformanceMonitoring) {
        this.performanceManager = new PerformanceManager({
          enableMonitoring: true,
          enableStartupProfiling: true,
          enableMemoryTracking: true,
          enableMetricsCollection: true,
        });

        this.performanceManager.startStartupPhase('framework_init', {
          description: 'TUI Framework initialization',
        });
      }

      // Initialize debug integration
      if (this.config.enableDebugMode) {
        this.debugIntegration = new DebugIntegration({
          enableInProduction: this.config.debugInProduction,
          enablePerformanceIntegration: this.config.enablePerformanceMonitoring,
        });

        if (this.performanceManager != null) {
          this.debugIntegration.setPerformanceManager(this.performanceManager);
        }

        this.debugIntegration.log(
          'info',
          'Framework',
          'TUI Framework initialization started'
        );
      }

      // Initialize terminal capabilities
      if (this.config.enableTerminalDetection) {
        this.capabilityDetector = new CapabilityDetector({
          enableAsync: true,
          enableCaching: true,
          fallbackToBasic: this.config.fallbackToBasic,
        });

        await this.capabilityDetector.detect();
        this.debugIntegration?.log(
          'info',
          'Terminal',
          'Terminal capabilities detected'
        );
      }

      // Initialize canvas
      this.canvas = new TerminalCanvas({
        enableDifferentialRendering: true,
        enablePerformanceOptimizations: true,
        terminalCapabilities: this.capabilityDetector?.getCapabilities(),
      });

      // Initialize error boundary
      if (this.config.enableErrorBoundaries) {
        this.errorBoundary = new ErrorBoundary({
          enableRecovery: this.config.enableCrashRecovery,
          enableStatePreservation: true,
          enableCleanShutdown: true,
        });

        this.errorBoundary.on('errorCaught', (data) => {
          this.state.errorCount++;
          this.debugIntegration?.log(
            'error',
            'Framework',
            'Error caught by boundary',
            data
          );
        });
      }

      // Initialize component registry
      this.componentRegistry = new ComponentRegistry({
        enableAutoRegistration: true,
        enableHotReload: this.config.enableDebugMode,
        enableMetrics: this.config.enablePerformanceMonitoring,
      });

      // Initialize event system
      this.eventManager = new EventManager({
        enablePriorityQueue: true,
        enableEventBatching: true,
        enableMetrics: this.config.enablePerformanceMonitoring,
      });

      this.keyboardHandler = new KeyboardHandler({
        enableShortcuts: this.config.enableKeyboardShortcuts,
        enableValidation: true,
        enableMetrics: this.config.enablePerformanceMonitoring,
      });

      // Initialize screen manager
      this.screenManager = new ScreenManager({
        enableTransitions: true,
        enableHistory: true,
        enableMetrics: this.config.enablePerformanceMonitoring,
      });

      // Initialize lifecycle manager
      this.lifecycle = new LifecycleManager({
        enableHooks: true,
        enableMetrics: this.config.enablePerformanceMonitoring,
      });

      // Initialize application loop
      this.applicationLoop = new ApplicationLoop({
        targetFPS: this.config.targetFPS,
        enablePerformanceMetrics: this.config.enablePerformanceMonitoring,
      });

      // Setup event handlers
      this.setupEventHandlers();

      // Complete initialization
      this.state.isInitialized = true;
      this.state.startupTime = performance.now() - startTime;

      if (this.performanceManager != null) {
        this.performanceManager.endStartupPhase('framework_init');
        this.performanceManager.addStartupMilestone(
          'framework_initialized',
          'Framework initialization completed'
        );
      }

      this.debugIntegration?.log(
        'info',
        'Framework',
        `TUI Framework initialized in ${this.state.startupTime.toFixed(2)}ms`
      );
      this.emit('initialized', { startupTime: this.state.startupTime });
    } catch (error) {
      this.debugIntegration?.log(
        'error',
        'Framework',
        'Framework initialization failed',
        error
      );
      this.state.errorCount++;
      throw error;
    }
  }

  private setupEventHandlers(): void {
    // Application loop events
    this.applicationLoop.on('frame', (data) => {
      this.handleFrame(data);
    });

    this.applicationLoop.on('input', (data) => {
      this.handleInput(data);
    });

    // Keyboard events
    this.keyboardHandler.on('keyPressed', (data) => {
      // First try debug integration
      if (this.debugIntegration?.handleKeyPress(data.key)) {
        return;
      }

      // Then try current screen
      const currentScreen = this.screenManager.getCurrentScreen();
      if (currentScreen) {
        currentScreen.handleKeyPress?.(data.key);
      }

      this.debugIntegration?.logComponentEvent('keyboard', 'keyPress', data);
    });

    // Screen manager events
    this.screenManager.on('screenChanged', (data) => {
      this.state.currentScreen = data.screen.getId();
      this.debugIntegration?.log(
        'info',
        'Navigation',
        `Screen changed to: ${data.screen.getId()}`
      );
    });

    // Error boundary events
    this.errorBoundary?.on('errorCaught', (data) => {
      this.debugIntegration?.log(
        'error',
        'ErrorBoundary',
        'Error caught',
        data
      );
    });

    // Performance events
    this.performanceManager?.on('performanceAlert', (data) => {
      this.debugIntegration?.log(
        'warn',
        'Performance',
        `Performance alert: ${data.alert.message}`,
        data
      );
    });

    // Graceful shutdown handling
    process.on('SIGINT', () => this.shutdown('SIGINT'));
    process.on('SIGTERM', () => this.shutdown('SIGTERM'));
  }

  private handleFrame(_data: unknown): void {
    if (!this.state.isRunning ?? this.isShuttingDown) return;

    try {
      // Update uptime
      this.state.uptime = performance.now();

      // Render current screen
      const currentScreen = this.screenManager.getCurrentScreen();
      if (currentScreen) {
        const context: RenderContext = {
          width: this.canvas.getWidth(),
          height: this.canvas.getHeight(),
          scrollX: 0,
          scrollY: 0,
        };

        const screenOutput = currentScreen.render(context);
        this.canvas.setContent(screenOutput);
      }

      // Render debug overlay if enabled
      if (this.debugIntegration?.isVisible()) {
        const debugOverlay = this.debugIntegration.renderOverlay(
          this.canvas.getWidth(),
          this.canvas.getHeight()
        );
        this.canvas.addOverlay(debugOverlay);
      }

      // Commit to terminal
      this.canvas.render();

      // Update component count
      this.state.componentCount = this.componentRegistry.getComponentCount();
    } catch (error) {
      this.errorBoundary?.handleError(error, 'frame-render');
    }
  }

  private handleInput(data: unknown): void {
    if (!this.state.isRunning) return;

    try {
      this.keyboardHandler.handleInput(data);
    } catch (error) {
      this.errorBoundary?.handleError(error, 'input-handling');
    }
  }

  // Public API
  public async start(): Promise<void> {
    if (!this.state.isInitialized) {
      throw new Error('Framework not initialized');
    }

    if (this.state.isRunning) {
      return;
    }

    this.debugIntegration?.log('info', 'Framework', 'Starting TUI Framework');

    // Start performance profiling for startup
    if (this.performanceManager != null) {
      this.performanceManager.startStartupPhase('application_start', {
        description: 'Application startup',
      });
    }

    // Start application loop
    await this.applicationLoop.start();
    this.state.isRunning = true;

    // Complete startup profiling
    if (this.performanceManager != null) {
      this.performanceManager.endStartupPhase('application_start');
      this.performanceManager.completeStartup();
    }

    this.debugIntegration?.log('info', 'Framework', 'TUI Framework started');
    this.emit('started');
  }

  public async stop(): Promise<void> {
    if (!this.state.isRunning) return;

    this.debugIntegration?.log('info', 'Framework', 'Stopping TUI Framework');

    this.state.isRunning = false;
    await this.applicationLoop.stop();

    this.debugIntegration?.log('info', 'Framework', 'TUI Framework stopped');
    this.emit('stopped');
  }

  public async shutdown(signal?: string): Promise<void> {
    if (this.isShuttingDown) return;

    this.isShuttingDown = true;
    this.debugIntegration?.log(
      'info',
      'Framework',
      `Shutting down TUI Framework (${signal ?? 'manual'})`
    );

    try {
      // Stop application loop
      await this.stop();

      // Cleanup components
      this.componentRegistry?.destroy();
      this.screenManager?.destroy();
      this.eventManager?.destroy();
      this.performanceManager?.destroy();
      this.canvas?.destroy();

      this.debugIntegration?.log(
        'info',
        'Framework',
        'TUI Framework shutdown complete'
      );
    } catch (error) {
      this.debugIntegration?.log(
        'error',
        'Framework',
        'Error during shutdown',
        error
      );
    }

    process.exit(0);
  }

  // Screen management
  public registerScreen(screen: Screen): void {
    this.screenManager.registerScreen(screen);
    this.debugIntegration?.log(
      'debug',
      'Framework',
      `Screen registered: ${screen.getId()}`
    );
  }

  public navigateToScreen(screenId: string, data?: unknown): void {
    this.screenManager.push(screenId, data);
    this.debugIntegration?.logComponentEvent('navigation', 'navigate', {
      screenId,
      data,
    });
  }

  public goBack(): boolean {
    const result = this.screenManager.pop();
    if (result != null) {
      this.debugIntegration?.logComponentEvent('navigation', 'back', {});
    }
    return result;
  }

  // Component management
  public registerComponent<T extends Component>(
    name: string,
    factory: () => T
  ): void {
    this.componentRegistry.register(name, factory);
    this.debugIntegration?.log(
      'debug',
      'Framework',
      `Component registered: ${name}`
    );
  }

  // Event handling
  public on(event: string, handler: Function): void {
    if (!this.eventHandlers.has(event)) {
      this.eventHandlers.set(event, new Set());
    }
    this.eventHandlers.get(event)?.add(handler);
  }

  public off(event: string, handler: Function): void {
    const handlers = this.eventHandlers.get(event);
    if (handlers != null) {
      handlers.delete(handler);
    }
  }

  private emit(event: string, data?: unknown): void {
    const handlers = this.eventHandlers.get(event);
    if (handlers != null) {
      handlers.forEach((handler) => {
        try {
          handler(data);
        } catch (error) {
          this.debugIntegration?.log(
            'error',
            'Framework',
            `Error in event handler for '${event}'`,
            error
          );
        }
      });
    }
  }

  // Getters
  public getState(): TUIFrameworkState {
    return { ...this.state };
  }

  public getConfig(): TUIFrameworkConfig {
    return { ...this.config };
  }

  public getPerformanceManager(): PerformanceManager {
    return this.performanceManager;
  }

  public getDebugIntegration(): DebugIntegration {
    return this.debugIntegration;
  }

  public getCanvas(): TerminalCanvas {
    return this.canvas;
  }

  public getScreenManager(): ScreenManager {
    return this.screenManager;
  }

  public getComponentRegistry(): ComponentRegistry {
    return this.componentRegistry;
  }

  // UIFramework interface implementation
  public render(_context: RenderContext): string {
    return this.canvas.render();
  }

  public handleEvent(event: unknown): void {
    this.eventManager.handleEvent(event);
  }

  public getMetrics(): unknown {
    return {
      framework: this.state,
      performance: this.performanceManager?.getPerformanceReport(),
      debug: this.debugIntegration?.getDebugManager().getMetrics(),
    };
  }
}
