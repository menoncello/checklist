# Variable Substitution System - Technical Design

**Story:** 3.4 - Basic Template Substitution
**Epic:** 3 - Templates & Security
**Version:** 1.0
**Last Updated:** 2025-10-10

## Overview

The Variable Substitution System provides secure, performant variable replacement in templates using a simple `${variable}` syntax. It integrates with the Variable Management System (Story 3.3) and Template Engine (Story 3.1) to enable dynamic, user-specific template processing.

## Design Goals

1. **Performance**: <5ms for typical templates (10-50 variables)
2. **Security**: No code execution, injection-safe operations only
3. **Usability**: Clear error messages with suggestions for typos
4. **Flexibility**: Support nested variables and default values
5. **Compatibility**: Seamless integration with existing systems

## Architecture

### Component Diagram

```
┌─────────────────────────────────────────────────────────┐
│                    TemplateEngine                       │
│  (Orchestrates template processing pipeline)            │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ├─→ VariableStore (Story 3.3)
                    │   └─→ Get variable values
                    │
                    ├─→ ComputedVariableEngine (Story 3.3)
                    │   └─→ Pre-evaluate computed variables
                    │
                    ├─→ VariableSubstitutor ◄─── NEW (Story 3.4)
                    │   ├─→ Parse template syntax
                    │   ├─→ Resolve nested variables
                    │   ├─→ Handle defaults
                    │   └─→ Generate result
                    │
                    └─→ SubstitutionPreview ◄─── NEW (Story 3.4)
                        └─→ Generate preview output
```

### Data Flow

```
1. User Template
   │
   └─→ "Hello ${name}, your project is in ${basePath}/${project}"

2. TemplateEngine.processTemplate()
   │
   ├─→ ComputedVariableEngine.evaluateAll()
   │   └─→ Pre-compute expressions
   │
   └─→ VariableSubstitutor.substitute()
       │
       ├─→ Step 1: Process escapes
       │   └─→ "\${literal}" → "__ESCAPED_xxx__"
       │
       ├─→ Step 2: Resolve nested variables (recursive)
       │   └─→ "${basePath}/${project}" → "/home/user/my-app"
       │
       ├─→ Step 3: Apply defaults
       │   └─→ "${env:-production}" → "production"
       │
       ├─→ Step 4: Restore escapes
       │   └─→ "__ESCAPED_xxx__" → "${literal}"
       │
       └─→ Return SubstitutionResult
           └─→ "Hello Alice, your project is in /home/user/my-app"
```

## Core Components

### 1. VariableSubstitutor

**Purpose:** Main substitution engine that parses templates and replaces variables

**Key Methods:**

```typescript
class VariableSubstitutor {
  // Primary substitution method
  substitute(template: string, stepId?: string): SubstitutionResult

  // Internal processing steps
  private processEscapes(text: string): string
  private resolveVariables(text: string, stepId?: string, ...): string
  private restoreEscapes(text: string): string
  private formatValue(value: VariableValue): string
  private createUndefinedVariableError(varName: string): SubstitutionError
  private fuzzyMatch(target: string, candidates: string[]): string[]
}
```

**Patterns Used:**

| Pattern | Regex | Purpose |
|---------|-------|---------|
| Basic Variable | `/\$\{([a-zA-Z0-9_.-]+)\}/g` | Match `${variable}` |
| Default Value | `/\$\{([a-zA-Z0-9_.-]+):-(.+?)\}/g` | Match `${var:-default}` |
| Escape Sequence | `/\\(\$\{[^}]+\})/g` | Match `\${literal}` |
| Nested Variable | `/\$\{([^}]*\$\{[^}]+\}[^}]*)\}/` | Detect nested patterns |

**Configuration:**

```typescript
interface SubstitutionConfig {
  maxNestingDepth: number;        // Default: 5
  allowUndefinedVariables: boolean; // Default: false
  useDefaultValues: boolean;      // Default: true
  enableCaching: boolean;         // Default: true
  escapePattern: string;          // Default: '\\'
}
```

### 2. SubstitutionPreview

**Purpose:** Generate preview output showing variable substitutions

**Key Methods:**

```typescript
class SubstitutionPreview {
  // Generate preview with highlighting
  generatePreview(template: string, stepId?: string): SubstitutionPreview

  // Format for terminal display
  formatForTerminal(preview: SubstitutionPreview): string

  // Internal helpers
  private extractVariablePositions(template: string, ...): VariablePreview[]
}
```

**Preview Format:**

```
Original:
  Hello ${name}, your project is in ${basePath}/${project}

Substituted:
  Hello Alice, your project is in /home/user/my-app

Variables:
  name = Alice
  basePath = /home/user
  project = my-app
```

### 3. Error Classes

```typescript
// Variable not found error
class VariableSubstitutionError extends Error {
  constructor(
    message: string,
    public variableName: string,
    public suggestions?: string[]
  )
}

// Nesting depth exceeded
class NestingDepthExceededError extends Error {
  constructor(
    public maxDepth: number,
    public currentDepth: number
  )
}

// Security violation
class SecurityError extends Error {
  constructor(message: string)
}
```

## Substitution Algorithm

### Phase 1: Escape Processing

```typescript
// Convert escape sequences to safe placeholders
Input:  "Path: \${HOME}/projects/${project}"
Step 1: Detect: "\${HOME}"
Step 2: Encode: "__ESCAPED_JHtIT01FfQ==__"
Output: "Path: __ESCAPED_JHtIT01FfQ==__/projects/${project}"
```

### Phase 2: Nested Resolution (Recursive)

```typescript
// Resolve inner-to-outer, max depth 5
Input:  "${basePath}/${projectName}/${file}"
Iteration 1: "${basePath}" → "/home/user"
            "${projectName}" → "my-app"
            "${file}" → "config.yaml"
Output: "/home/user/my-app/config.yaml"

// Nested example
Input:  "${var1.${var2}}"
Iteration 1 (inner): "${var2}" → "subkey"
Iteration 2 (outer): "${var1.subkey}" → "value"
Output: "value"
```

### Phase 3: Default Value Application

```typescript
// Apply defaults when variable is undefined
Input:  "${environment:-production}"
Check:  VariableStore.get("environment") → undefined
Result: "production"

Input:  "${port:-3000}"
Check:  VariableStore.get("port") → undefined
Result: "3000"
```

### Phase 4: Escape Restoration

```typescript
// Decode placeholders back to literals
Input:  "Path: __ESCAPED_JHtIT01FfQ==__/projects/my-app"
Step 1: Decode: "__ESCAPED_JHtIT01FfQ==__" → "${HOME}"
Output: "Path: ${HOME}/projects/my-app"
```

## Security Design

### Threat Model

| Threat | Mitigation |
|--------|-----------|
| Code Injection | No eval, no Function(), no template literals |
| SQL Injection | Variable name validation, value sanitization |
| Command Injection | Safe string replacement only, no shell execution |
| Path Traversal | Variable name pattern enforcement |
| DoS via Nesting | Maximum nesting depth limit (5) |
| DoS via Regex | Compiled patterns, timeout limits |

### Security Controls

1. **Variable Name Validation**
   ```typescript
   const ALLOWED_VARIABLE_NAME = /^[a-zA-Z0-9_.-]+$/;
   if (!ALLOWED_VARIABLE_NAME.test(varName)) {
     throw new SecurityError(`Invalid variable name: ${varName}`);
   }
   ```

2. **Safe String Operations**
   ```typescript
   // ✅ SAFE: String.prototype.replace with function
   text.replace(pattern, (match, varName) => {
     return sanitize(variableStore.get(varName));
   });

   // ❌ UNSAFE: Never use these
   eval(`\`${template}\``);           // Code execution
   new Function(`return \`${template}\``)(); // Code execution
   ```

3. **Audit Logging**
   ```typescript
   logger.info({
     msg: 'Variable substitution',
     templateId,
     variableCount: result.metadata.variableCount,
     nestingDepth: result.metadata.nestingDepth,
     duration: result.metadata.duration,
   });
   ```

## Performance Design

### Performance Targets

| Operation | Target | Measurement |
|-----------|--------|-------------|
| Simple template (1-5 vars) | <1ms | Tinybench |
| Typical template (10-50 vars) | <5ms | Tinybench |
| Complex template (50-100 vars) | <15ms | Tinybench |
| Nested variables (per level) | <10ms | Tinybench |
| Preview generation | <10ms | Tinybench |

### Optimization Strategies

1. **Compiled Regex Patterns**
   ```typescript
   // ✅ GOOD: Compile once, reuse many times
   private static readonly VARIABLE_PATTERN = /\$\{([a-zA-Z0-9_.-]+)(?::-(.*?))?\}/g;

   // ❌ BAD: Recompile on every call
   substitute(template: string) {
     return template.replace(/\$\{([a-zA-Z0-9_.-]+)\}/g, ...); // Slow
   }
   ```

2. **Caching Strategy** (Future Enhancement)
   ```typescript
   // Cache frequently used templates
   private cache = new LRUCache<string, SubstitutionResult>(100);

   substitute(template: string, stepId?: string): SubstitutionResult {
     const cacheKey = `${template}:${stepId}`;
     if (this.cache.has(cacheKey)) {
       return this.cache.get(cacheKey)!;
     }

     const result = this.performSubstitution(template, stepId);
     this.cache.set(cacheKey, result);
     return result;
   }
   ```

3. **Early Exit Optimization**
   ```typescript
   // Skip processing if no variables in template
   if (!template.includes('${')) {
     return {
       output: template,
       variablesUsed: [],
       errors: [],
       metadata: { duration: 0, variableCount: 0, nestingDepth: 0 },
     };
   }
   ```

## Integration Points

### With VariableStore (Story 3.3)

```typescript
// Retrieve variable with scope awareness
const value = this.variableStore.get(variableName, stepId);

// Step-level variables override global
// VariableStore handles scope resolution internally
```

### With TemplateEngine (Story 3.1)

```typescript
// TemplateEngine orchestrates the pipeline
export class TemplateEngine {
  async processTemplate(template: string, stepId?: string): Promise<string> {
    // 1. Pre-evaluate computed variables
    await this.computedEngine.evaluateAll(stepId);

    // 2. Perform substitution (NEW)
    const result = this.substitutor.substitute(template, stepId);

    if (result.errors.length > 0) {
      throw new TemplateProcessingError('Substitution failed', result.errors);
    }

    // 3. Return processed template
    return result.output;
  }
}
```

### With ComputedVariableEngine (Story 3.3)

```typescript
// Computed variables are pre-evaluated before substitution
// VariableSubstitutor treats them as regular variables

// Example:
// 1. ComputedVariableEngine evaluates: fullPath = `${basePath}/${project}`
// 2. Result stored in VariableStore: fullPath = "/home/user/my-app"
// 3. VariableSubstitutor simply retrieves: ${fullPath} → "/home/user/my-app"
```

## Error Handling

### Error Types and Recovery

| Error Type | Recovery Strategy | User Action |
|------------|------------------|-------------|
| Undefined Variable | Suggest similar variables | Define variable or use default |
| Nesting Depth Exceeded | Stop processing, return partial | Simplify template nesting |
| Invalid Variable Name | Reject with clear message | Fix variable name syntax |
| Circular Reference | Detect and throw error | Restructure variable dependencies |

### Error Message Examples

**Good Error Messages:**

```
❌ Variable 'projectNmae' is not defined
   Did you mean: projectName, project, name?

❌ Maximum nesting depth of 5 exceeded (current: 6)
   Simplify your template or increase maxNestingDepth

❌ Invalid variable name: 'my-var!@#'
   Variable names must match: [a-zA-Z0-9_.-]+
```

**Bad Error Messages:**

```
❌ Undefined variable
❌ Error
❌ Processing failed
```

## Testing Strategy

### Unit Test Coverage

| Component | Coverage Target | Test Count (Estimated) |
|-----------|----------------|----------------------|
| VariableSubstitutor | 95%+ | 40+ tests |
| SubstitutionPreview | 90%+ | 15+ tests |
| Error Handling | 100% | 20+ tests |
| Security Tests | 100% | 15+ tests |
| Performance Tests | 100% | 8+ tests |

### Test Categories

1. **Basic Substitution**
   - Single variable
   - Multiple variables
   - Variable types (string, number, boolean, array)

2. **Nested Variables**
   - Single-level nesting
   - Multi-level nesting (2-5 levels)
   - Maximum depth enforcement

3. **Default Values**
   - Undefined variables
   - Null vs undefined
   - Empty string handling
   - Nested defaults

4. **Escape Sequences**
   - Single escape
   - Double escape
   - Mixed escaped/unescaped

5. **Security**
   - SQL injection attempts
   - Command injection attempts
   - Script injection attempts
   - Path traversal attempts

6. **Performance**
   - Simple templates (<1ms)
   - Typical templates (<5ms)
   - Complex templates (<15ms)

## Future Enhancements

### Phase 2 (Story 3.5 - Advanced Features)

- Conditionals: `{{#if condition}}...{{/if}}`
- Loops: `{{#each items}}...{{/each}}`
- Functions: `${fn:uppercase(var)}`
- Math expressions: `${count + 1}`

### Phase 3 (Performance Optimization)

- LRU caching for repeated templates
- Parallel processing for independent variables
- Template precompilation

### Phase 4 (Developer Experience)

- VSCode syntax highlighting for templates
- Template validation in CI/CD
- Template debugging tools

## References

- **Story 3.3**: Variable Management System (VariableStore, types, scoping)
- **Story 3.1**: Template Loading with Sandbox (TemplateEngine, caching)
- **Story 3.2**: Template Security System (audit logging, security patterns)
- **Architecture**: `docs/architecture/tech-stack.md`
- **Coding Standards**: `docs/architecture/coding-standards.md`
- **Testing Strategy**: `docs/architecture/testing-strategy.md`

## Appendix: Syntax Reference

### Supported Syntax

| Syntax | Example | Result | Notes |
|--------|---------|--------|-------|
| Basic Variable | `${name}` | `Alice` | Simple substitution |
| Nested Variable | `${base.${key}}` | `value` | Inner-to-outer resolution |
| Default Value | `${env:-dev}` | `dev` | Use default if undefined |
| Escape Literal | `\${notAVar}` | `${notAVar}` | Preserve literal text |
| Double Escape | `\\${var}` | `\Alice` | Escape the escape |

### Variable Naming Rules

- **Allowed characters**: `a-z`, `A-Z`, `0-9`, `_`, `.`, `-`
- **Must start with**: Letter or underscore
- **Examples**:
  - ✅ `projectName`
  - ✅ `user.name`
  - ✅ `config-value`
  - ✅ `_internal`
  - ❌ `my-var!`
  - ❌ `123start`
  - ❌ `has spaces`

---

**Document Version:** 1.0
**Last Updated:** 2025-10-10
**Author:** Bob (Scrum Master)
**Status:** Complete
