# Story 1.10: Logging and Mutation Testing Infrastructure

## Status
Draft

## Story
**As a** developer,  
**I want** Pino logging integrated throughout the application with structured logging AND StrykerJS configured for mutation testing,  
**So that** we have production-ready logging and high-quality test coverage validation.

## Acceptance Criteria
1. Pino logger configured with default log levels (debug, info, warn, error, fatal)
2. Structured JSON output format for all log entries
3. Log rotation implemented with configurable file size and retention policies  
4. File output configured with separate files for different log levels
5. Support for 3rd party logging services integration (e.g., Datadog, Splunk, CloudWatch)
6. Debug library completely replaced with Pino throughout the codebase
7. StrykerJS configured to run mutation testing on all unit test files
8. Mutation score threshold set to 85% minimum
9. StrykerJS integrated into CI/CD pipeline with failure on threshold breach
10. All default mutators enabled for comprehensive mutation coverage
11. Performance: Logging overhead must not exceed 5ms per operation
12. All log entries include contextual metadata (timestamp, module, trace ID)

## Tasks / Subtasks
- [ ] **Task 1: Setup Pino Logger Infrastructure** (AC: 1, 2, 11, 12)
  - [ ] Install Pino and required dependencies (`pino`, `pino-pretty`, `pino-roll`)
  - [ ] Create logger factory in `packages/core/src/utils/logger.ts`
  - [ ] Configure default log levels and JSON formatting
  - [ ] Implement context injection for trace IDs and module names
  - [ ] Create type definitions for logger interface

- [ ] **Task 2: Implement Log Rotation and File Output** (AC: 3, 4)
  - [ ] Configure pino-roll for log rotation with size and time-based policies
  - [ ] Setup separate file streams for different log levels
  - [ ] Implement log directory structure (`.logs/info/`, `.logs/error/`, etc.)
  - [ ] Add configuration for retention policies in config file
  - [ ] Create cleanup task for old log files
  - [ ] Implement fallback to console output on rotation failure
  - [ ] Add disk space monitoring with warnings at 90% capacity

- [ ] **Task 3: Add 3rd Party Service Integration** (AC: 5)
  - [ ] Create abstract transport interface for external services
  - [ ] Implement plugin system for service adapters
  - [ ] Add configuration schema for service credentials
  - [ ] Create example integration for at least one service
  - [ ] Document integration process for additional services

- [ ] **Task 4: Replace Debug Library with Pino** (AC: 6)
  - [ ] Audit all files using Debug library
  - [ ] Create migration script to convert Debug calls to Pino
  - [ ] Update all import statements from 'debug' to new logger
  - [ ] Remove Debug library from dependencies
  - [ ] Update environment variable documentation (DEBUG → LOG_LEVEL)

- [ ] **Task 5: Setup StrykerJS Mutation Testing** (AC: 7, 10)
  - [ ] Install StrykerJS and required plugins (`@stryker-mutator/core@8.2.x`, `@stryker-mutator/typescript-checker`, `@stryker-mutator/jest-runner`)
  - [ ] Create `stryker.conf.js` configuration file in project root
  - [ ] Configure package manager as 'npm' and command runner as 'npm'
  - [ ] Configure mutation patterns: `['packages/*/src/**/*.ts', '!**/*.test.ts', '!**/*.spec.ts']`
  - [ ] Enable all default mutators (no exclusions)
  - [ ] Setup HTML reporter output to `reports/mutation/index.html`
  - [ ] Configure incremental testing with `.stryker-tmp/incremental.json`
  - [ ] Set concurrency to 4 threads for parallel testing

- [ ] **Task 6: Configure Mutation Score Threshold** (AC: 8)
  - [ ] Set threshold configuration in stryker.conf.js: `thresholds: { high: 95, low: 90, break: 85 }`
  - [ ] Configure break-on-threshold behavior to fail CI if below 85%
  - [ ] Add reporters: `['html', 'json', 'progress', 'dashboard']`
  - [ ] Setup dashboard integration for project tracking
  - [ ] Create baseline mutation score report

- [ ] **Task 7: Improve Test Coverage for Mutation Testing** (AC: 8)
  - [ ] Run initial StrykerJS analysis to identify surviving mutants
  - [ ] Analyze mutation report to find gaps in test assertions
  - [ ] Create new test cases to kill surviving mutants
  - [ ] Strengthen existing tests with additional assertions
  - [ ] Focus on boundary conditions and edge cases
  - [ ] Add tests for error handling paths
  - [ ] Ensure all conditional branches are tested

- [ ] **Task 8: Integrate StrykerJS with CI/CD** (AC: 9)
  - [ ] Add mutation testing step to GitHub Actions workflow after unit tests
  - [ ] Configure job to fail if mutation score < 85%
  - [ ] Setup mutation score badge for README using Stryker Dashboard
  - [ ] Add mutation report artifacts to CI output (reports/mutation/)
  - [ ] Configure incremental mutation testing for PRs using `.stryker-tmp/incremental.json`
  - [ ] Set timeout to 60000ms for CI environment

- [ ] **Task 9: Performance Testing and Documentation** (AC: 11)
  - [ ] Create benchmark tests for logging overhead
  - [ ] Validate <5ms per log operation requirement
  - [ ] Document logger usage patterns and best practices
  - [ ] Create migration guide from Debug to Pino
  - [ ] Update developer documentation with mutation testing workflow

## Dev Notes

### Testing Standards
Based on `docs/architecture/testing-strategy-complete-with-all-testing-utilities.md`:
- Test files location: `*.test.ts` alongside source files
- Use Bun Test as the test runner
- Tests must follow the TestDataFactory pattern for consistency
- Visual regression testing available via VisualRegressionTester class
- Flaky test detection implemented via FlakyTestDetector
- [Source: architecture/testing-strategy-complete-with-all-testing-utilities.md#mutation-testing-strategy]

### Pino Logger Configuration
From `docs/architecture/tech-stack.md`:
- **Pino**: Version 9.x for production-ready logging
- **pino-roll**: Version 1.x for log file management and rotation
- **pino-pretty**: Version 10.x for development log formatting
- High-performance JSON logger with structured logging support
- [Source: architecture/tech-stack.md#development-tools]

### Current Logging Setup
From `docs/architecture/tech-stack.md`:
- Currently using Debug library (4.3.x) for development logging
- Debug provides lightweight logging with namespaces
- Must maintain namespace compatibility during migration
- [Source: architecture/tech-stack.md#development-tools]

### File Locations and Structure
From `docs/architecture/source-tree.md`:
- Logger utility: `packages/core/src/utils/logger.ts`
- Log directory structure: `.logs/info/`, `.logs/error/`, `.logs/debug/`
- StrykerJS config: `stryker.conf.js` in project root
- Mutation reports: `reports/mutation/index.html`
- StrykerJS temp files: `.stryker-tmp/`
- Test files: Located alongside source files (`*.test.ts`)
- [Source: architecture/source-tree.md#project-structure]

### Coding Standards Compliance
From `docs/architecture/coding-standards.md`:
- ESLint rule `'no-console': 'warn'` - must use logger instead
- Debug logging must use namespaced patterns: `'checklist:module:component'`
- All async operations must include trace IDs for debugging
- Resource cleanup must be implemented for file handles
- [Source: architecture/coding-standards.md]

### Performance Requirements
From Epic 1 Story 1.1:
- Overall performance budget: <50ms startup, <50MB memory
- Logging must not significantly impact these budgets
- Consider lazy initialization for file streams
- [Source: prd/epic-1-foundation-validation.md#story-1.1]

### Monorepo Structure
From `docs/architecture/source-tree.md`:
- Logger utility goes in `packages/core/src/utils/`
- Each package can import from `@checklist/core`
- Maintain package boundaries (CLI/TUI → Core only)
- Workspace packages: core, tui, shared, cli
- [Source: architecture/source-tree.md#key-directories]

### StrykerJS Configuration Details
From `docs/architecture/testing-strategy-complete-with-all-testing-utilities.md`:
- StrykerJS version 8.2.x already listed in tech stack
- Package manager: 'npm' (Bun not supported by StrykerJS)
- Command runner: 'npm' for StrykerJS execution
- Mutation threshold: 85% minimum (break CI if below)
- Target goal: 95% high, 90% low thresholds
- Coverage analysis: 'perTest' for optimal performance
- Incremental testing enabled for faster PR validation
- HTML reporter output: `reports/mutation/index.html`
- Dashboard integration for tracking trends
- Concurrency: 4 threads for parallel mutation testing
- [Source: architecture/testing-strategy-complete-with-all-testing-utilities.md#mutation-testing-strategy]

### CI/CD Integration
- GitHub Actions used for CI/CD (latest version)
- Multi-platform builds must be supported
- Mutation testing should run after unit tests pass
- Automatic failure if mutation score < 85%
- [Source: architecture/tech-stack.md#build-distribution]

### Health Monitoring Integration
From `docs/architecture/monitoring-and-observability.md`:
- Logger must integrate with HealthMonitor system
- Performance tracking for logging operations
- Error correlation with monitoring stack
- [Source: architecture/monitoring-and-observability.md#health-check-system]

### Error Handling and Edge Cases
- **Log Rotation Failures**: Implement fallback to console output if file rotation fails
- **Disk Space Issues**: Monitor available disk space, emit warning at 90% capacity
- **Permission Errors**: Gracefully degrade to stdout if log directory is not writable
- **Corrupted Log Files**: Detect and quarantine corrupted logs, start fresh log file
- **StrykerJS Timeout**: Increase timeout for large codebases, max 10 minutes
- **Memory Constraints**: Implement log buffering with automatic flush at 1000 entries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-01-08 | 1.1 | Enhanced with architecture context, corrected StrykerJS config for npm, added edge cases | Bob (SM) |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results

### Risk Profile Assessment - 2025-01-08
**Reviewer**: Quinn (Test Architect)
**Assessment Type**: Risk Profile Analysis
**Risk Score**: 37/100 (High Risk - Immediate attention required)

#### Risk Summary
- **Total Risks Identified**: 15
- **Critical**: 2 (SEC-001: Sensitive data exposure, DATA-001: Disk exhaustion)
- **High**: 4 (Performance overhead, migration complexity, CI timeout, log injection)
- **Medium**: 5
- **Low**: 4

#### Critical Risks Requiring Immediate Mitigation
1. **SEC-001: Sensitive Data Exposure in Logs** (Score: 9)
   - High probability of PII/credentials in logs
   - Requires PII detection, redaction, and audit mechanisms

2. **DATA-001: Log File Disk Exhaustion** (Score: 9)
   - Production log volumes can fill disk causing system failure
   - Needs aggressive rotation, monitoring at 70/85/95% thresholds

#### High Priority Concerns
- **PERF-001**: Logging overhead must stay under 5ms requirement
- **TECH-001**: Debug to Pino migration complexity across codebase
- **OPS-001**: StrykerJS may timeout in CI pipeline
- **SEC-002**: Log injection attack vectors

#### Testing Requirements
**Priority 1 (Critical)**:
- Security scanning for PII in logs
- Load testing with 10GB+ log generation
- Chaos testing for disk full scenarios

**Priority 2 (High)**:
- Performance benchmarking under load
- Migration validation testing
- CI/CD pipeline stress testing

#### Recommendations
**Must Fix Before Production**:
- Implement PII detection and redaction
- Configure log rotation with disk monitoring
- Validate <5ms performance requirement

**Risk-Based Deployment**:
- Use feature flags for gradual rollout
- Implement compatibility layer for migration
- Maintain rollback capability

#### Gate Decision
**CONCERNS** - Story has significant risks requiring mitigation before production deployment

**Risk Profile Location**: `docs/qa/assessments/1.10-risk-20250108.md`

### Test Design Assessment - 2025-01-08
**Reviewer**: Quinn (Test Architect)
**Assessment Type**: Comprehensive Test Design
**Total Scenarios**: 48 (28 Unit, 14 Integration, 6 E2E)

#### Test Coverage Summary
- **Priority Distribution**: P0: 18, P1: 16, P2: 10, P3: 4
- **Risk Coverage**: All critical and high risks addressed
- **Performance Tests**: 5 scenarios for <5ms validation
- **Security Tests**: 3 scenarios for PII/injection prevention

#### Key Test Scenarios

**P0 Critical Tests**:
1. Logger performance under load (< 5ms requirement)
2. PII detection and redaction mechanisms
3. Disk exhaustion handling and rotation
4. Migration from Debug library validation
5. CI/CD mutation testing integration (85% threshold)

**Test Execution Phases**:
- Phase 1: 18 P0 tests (critical path)
- Phase 2: 16 P1 tests (essential features)
- Phase 3: 14 P2/P3 tests (extended coverage)

#### Test Environment Requirements
- 4+ cores for parallel mutation testing
- 10GB+ disk space for rotation testing
- Docker containers for service mocks
- Performance profiling tools

#### Coverage Targets
- Line coverage: 95% minimum
- Branch coverage: 90% minimum
- Mutation score: 85% minimum (CI gate)
- All P0 tests must pass

**Test Design Location**: `docs/qa/assessments/1.10-test-design-20250108.md`