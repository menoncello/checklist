# Story 1.12: StrykerJS Mutation Testing Infrastructure

## Status
Ready for Development

## Story
**As a** developer,  
**I want** StrykerJS configured for mutation testing with Bun integration,  
**So that** we have high-quality test coverage validation and can identify weak test assertions.

## Acceptance Criteria
1. StrykerJS configured with command runner to execute Bun tests directly
2. Mutation score threshold set to 85% minimum
3. StrykerJS integrated into CI/CD pipeline with failure on threshold breach
4. All default mutators enabled for comprehensive mutation coverage
5. HTML reporter configured for visual mutation reports
6. Incremental testing enabled for faster PR validation
7. Dashboard integration for tracking mutation score trends
8. Parallel execution configured for optimal performance

## Tasks / Subtasks

- [ ] **Task 1: Setup StrykerJS with Bun Command Runner** (AC: 1)
  - [ ] Install StrykerJS core only: `@stryker-mutator/core@9.1.x`
  - [ ] Create `stryker.conf.js` configuration file in project root
  - [ ] Configure with packageManager: 'npm' and testRunner: 'command'
  - [ ] Setup commandRunner to execute: 'bun test --bail --coverage'
  - [ ] Configure mutation patterns: `['packages/*/src/**/*.ts', '!**/*.test.ts', '!**/*.spec.ts']`
  - [ ] Enable all default mutators (no exclusions)
  - [ ] Setup HTML reporter output to `reports/mutation/index.html`
  - [ ] Configure incremental testing with `.stryker-tmp/incremental.json`
  - [ ] Set concurrency to 4 threads for parallel testing

- [ ] **Task 2: Configure Mutation Score Threshold** (AC: 2)
  - [ ] Set threshold configuration in stryker.conf.js: `thresholds: { high: 95, low: 90, break: 85 }`
  - [ ] Configure break-on-threshold behavior to fail CI if below 85%
  - [ ] Add reporters: `['html', 'json', 'progress', 'dashboard']`
  - [ ] Setup dashboard integration for project tracking
  - [ ] Create baseline mutation score report
  - [ ] Verify Bun test execution through command runner

- [ ] **Task 3: Validate StrykerJS with Bun Command Runner** (AC: 1)
  - [ ] Create test project with minimal Bun test setup
  - [ ] Install StrykerJS core only: `@stryker-mutator/core@9.1.x`
  - [ ] Configure command runner to execute `bun test`
  - [ ] Verify mutation testing runs successfully
  - [ ] Document any workarounds or configuration tweaks needed
  - [ ] Validate HTML reporter output generation
  - [ ] Test incremental mode functionality

- [ ] **Task 4: Improve Test Coverage for Mutation Testing** (AC: 2)
  - [ ] Run initial StrykerJS analysis to identify surviving mutants
  - [ ] Analyze mutation report to find gaps in test assertions
  - [ ] **Core Module Tests** - Target 90% mutation score:
    - [ ] Strengthen assertions for boundary conditions
    - [ ] Add tests for error handling paths
    - [ ] Cover all conditional branches
    - [ ] Test null/undefined edge cases
  - [ ] **State Management Tests** - Target 85% mutation score:
    - [ ] Test state transitions thoroughly
    - [ ] Verify all validation rules
    - [ ] Test concurrent operation scenarios
    - [ ] Cover rollback and recovery paths
  - [ ] **CLI Module Tests** - Target 85% mutation score:
    - [ ] Test command parsing variations
    - [ ] Verify error message outputs
    - [ ] Test flag combinations
    - [ ] Cover help text generation
  - [ ] **Workflow Engine Tests** - Target 95% mutation score:
    - [ ] Test all condition evaluations
    - [ ] Verify workflow transitions
    - [ ] Test error handling in workflows
    - [ ] Cover all workflow states

- [ ] **Task 5: Integrate StrykerJS with CI/CD** (AC: 3, 6)
  - [ ] Add mutation testing step to GitHub Actions workflow after unit tests
  - [ ] Configure job to fail if mutation score < 85%
  - [ ] Setup mutation score badge for README using Stryker Dashboard
  - [ ] Add mutation report artifacts to CI output (reports/mutation/)
  - [ ] Configure incremental mutation testing for PRs using `.stryker-tmp/incremental.json`
  - [ ] Set timeout to 60000ms for CI environment
  - [ ] Configure caching for `.stryker-tmp` directory

- [ ] **Task 6: Setup Dashboard and Reporting** (AC: 5, 7)
  - [ ] Configure Stryker Dashboard project token
  - [ ] Setup automatic upload of mutation results
  - [ ] Configure HTML reporter with custom branding
  - [ ] Create mutation score trend tracking
  - [ ] Setup notifications for score degradation
  - [ ] Document how to interpret mutation reports

- [ ] **Task 7: Performance Optimization** (AC: 8)
  - [ ] Analyze and optimize StrykerJS performance
  - [ ] Configure optimal concurrency based on CI resources
  - [ ] Setup file filtering to exclude non-testable files
  - [ ] Optimize test runner command for faster execution
  - [ ] Configure memory limits to prevent OOM errors
  - [ ] Implement caching strategy for faster re-runs

## Testing

### Test Strategy
- **Mutation Testing**: Achieve 85% minimum mutation score across all modules
- **Performance Testing**: Ensure mutation testing completes within CI timeout
- **Integration Testing**: Verify StrykerJS works correctly with Bun test runner
- **Report Validation**: Confirm HTML and JSON reports are generated correctly

### StrykerJS Configuration for Bun

**Correct Configuration for Bun Support:**

```javascript
// stryker.conf.js
module.exports = {
  packageManager: 'npm',  // Required for StrykerJS
  testRunner: 'command',   // Use command runner for Bun
  commandRunner: {
    command: 'bun test --bail --coverage'  // Execute Bun directly
  },
  mutate: ['packages/*/src/**/*.ts', '!**/*.test.ts', '!**/*.spec.ts'],
  thresholds: { high: 95, low: 90, break: 85 },
  reporters: ['html', 'json', 'progress', 'dashboard'],
  htmlReporter: {
    fileName: 'reports/mutation/index.html'
  },
  incremental: true,
  incrementalFile: '.stryker-tmp/incremental.json',
  concurrency: 4,
  timeoutMS: 60000,
  disableTypeChecks: false
};
```

### Package.json Scripts

```json
{
  "scripts": {
    "test": "bun test",
    "test:mutation": "bunx stryker run",
    "test:mutation:incremental": "bunx stryker run --incremental"
  }
}
```

### Validation Steps
1. Run mutation tests locally: `bunx stryker run`
2. Verify HTML report: Open `reports/mutation/index.html`
3. Check mutation score meets 85% threshold
4. Validate incremental mode: `bunx stryker run --incremental`
5. Test CI integration: Push changes and verify GitHub Actions

## Dev Notes

### Architecture Context

**Testing Infrastructure** [Source: architecture/testing-strategy-complete-with-all-testing-utilities.md#mutation-testing-strategy]:
- StrykerJS version 9.1.x (updated to latest stable version)
- Command runner configuration for Bun compatibility
- Mutation score threshold: 85% minimum (break), 90% low, 95% high
- Reports output to `reports/mutation/` directory as per source tree structure
- Incremental testing file stored in `.stryker-tmp/incremental.json`

**Tech Stack Requirements** [Source: architecture/tech-stack.md#testing-suite]:
- StrykerJS 9.1.x for mutation testing (test quality validation - updated to latest)
- Bun Test (built-in) for unit and integration tests
- Bun Coverage (built-in) for coverage reporting
- npm audit (built-in) for security scanning dependencies

**Project Structure Alignment** [Source: architecture/source-tree.md#project-structure]:
- Configuration file: `stryker.conf.js` in project root
- Reports directory: `reports/mutation/` for HTML reports
- Temporary files: `.stryker-tmp/` for incremental testing cache
- Test files location: `packages/*/tests/` following monorepo structure

**Coding Standards** [Source: architecture/coding-standards.md#eslint-configuration-rules]:
- Follow ESLint rules for TypeScript code quality
- No console.log - use Pino logger instead
- Mandatory security rules: no-eval, no-unsafe-regex
- Import organization must follow defined groups

### Bun Compatibility for StrykerJS

**Issue:** StrykerJS does not natively support Bun as a test runner or package manager.

**Solution:** Use command runner to execute Bun tests:
1. Use `bunx` to execute StrykerJS directly without installing globally
2. Configure command runner to execute `bun test`
3. This allows StrykerJS to mutate code while using Bun for test execution

### CI/CD Integration
- Install Bun in CI environment
- Run `bun install` for dependencies
- Run `bunx stryker run` for mutation testing (executes Bun tests via command runner)
- Cache Bun cache directory
- Cache `.stryker-tmp` for incremental testing

### Mutation Testing Goals by Module

| Module | Target Score | Priority | Notes |
|--------|-------------|----------|-------|
| Workflow Engine | 95% | P0 | Critical business logic |
| Core Utils | 90% | P0 | Foundation utilities |
| State Management | 85% | P1 | Complex state handling |
| CLI Commands | 85% | P1 | User-facing functionality |
| TUI Components | 80% | P2 | Visual components |
| Test Utilities | 75% | P3 | Testing infrastructure |

### Performance Considerations
- Mutation testing is CPU-intensive
- Configure concurrency based on available cores
- Use incremental mode for PR validation
- Full mutation testing only on main branch merges
- Consider using `--since` flag for changed files only

### Troubleshooting Common Issues

1. **Timeout Errors**:
   - Increase `timeoutMS` in configuration
   - Reduce concurrency if memory-constrained
   - Use `--logLevel debug` for diagnostics

2. **False Positives**:
   - Some mutants may be equivalent (no behavioral change)
   - Document known equivalent mutants
   - Use `// Stryker disable` comments sparingly

3. **Performance Issues**:
   - Use incremental mode for local development
   - Configure file filters to exclude generated code
   - Optimize test suite for faster execution

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Split from original Story 1.10 - Focus on StrykerJS mutation testing only | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)