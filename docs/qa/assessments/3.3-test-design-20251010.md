# Test Design: Story 3.3 - Variable Management System

**Date**: 2025-10-10
**Designer**: Quinn (Test Architect)
**Story ID**: 3.3
**Story Title**: Variable Management System

---

## Test Strategy Overview

- **Total Test Scenarios**: 67
- **Unit Tests**: 42 (62.7%)
- **Integration Tests**: 21 (31.3%)
- **E2E Tests**: 4 (6.0%)
- **Priority Distribution**:
  - P0: 28 tests (41.8%)
  - P1: 24 tests (35.8%)
  - P2: 15 tests (22.4%)

### Test Philosophy

This test design follows a **shift-left strategy** with heavy emphasis on unit testing for business logic and algorithm correctness, integration tests for component interactions and persistence, and minimal E2E tests for critical user journeys. Given the high-risk nature of this story (Risk Score: 2/100), comprehensive P0 coverage is mandatory for critical risks (SEC-001, DATA-003).

---

## Test Scenarios by Acceptance Criteria

### AC1: Variables Defined with Types and Defaults

**Test Focus**: Variable definition parsing, type system validation, default value handling

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                    | Justification                      | Mitigates Risk |
| ------------- | ----------- | -------- | ------------------------------------------------ | ---------------------------------- | -------------- |
| 3.3-UNIT-001  | Unit        | P0       | Validate variable definition schema with Ajv     | Schema validation is core security | DATA-002       |
| 3.3-UNIT-002  | Unit        | P0       | Parse variable definition with all types         | Type system correctness            | DATA-002       |
| 3.3-UNIT-003  | Unit        | P1       | Apply default values for undefined variables     | Common use case                    | -              |
| 3.3-UNIT-004  | Unit        | P1       | Validate variable metadata (description, rules)  | Data integrity                     | -              |
| 3.3-UNIT-005  | Unit        | P2       | Handle missing optional fields gracefully        | Edge case handling                 | -              |
| 3.3-INT-001   | Integration | P1       | Load variable definitions from template YAML     | Template integration critical      | -              |
| 3.3-INT-002   | Integration | P2       | Export variable definitions to public API        | API contract validation            | -              |

**Total AC1**: 7 tests (5 unit, 2 integration)

---

### AC2: Required Variables Prompted During Init

**Test Focus**: Required variable identification, user prompting flow, validation with retry

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                        | Justification                       | Mitigates Risk |
| ------------- | ----------- | -------- | ---------------------------------------------------- | ----------------------------------- | -------------- |
| 3.3-UNIT-006  | Unit        | P0       | Identify required variables from definitions         | Core logic for prompting            | -              |
| 3.3-UNIT-007  | Unit        | P0       | Validate user input against variable type            | Type safety                         | DATA-002       |
| 3.3-UNIT-008  | Unit        | P0       | Validate user input against validation rules         | Security and data integrity         | SEC-003        |
| 3.3-UNIT-009  | Unit        | P1       | Handle validation retry logic (max 3 attempts)       | User experience                     | -              |
| 3.3-UNIT-010  | Unit        | P1       | Use default values in prompts                        | Usability                           | -              |
| 3.3-UNIT-011  | Unit        | P2       | Generate clear prompt messages from metadata         | UX quality                          | -              |
| 3.3-INT-003   | Integration | P0       | Mock IPromptProvider interface for testing           | TUI integration dependency          | TECH-002       |
| 3.3-INT-004   | Integration | P1       | End-to-end prompting flow with validation            | Critical user flow                  | TECH-002       |
| 3.3-INT-005   | Integration | P1       | Store prompted values in global scope                | Data persistence correctness        | -              |
| 3.3-E2E-001   | E2E         | P0       | User init with required variables (full TUI flow)    | Critical user journey               | TECH-002       |

**Total AC2**: 10 tests (6 unit, 3 integration, 1 e2e)

---

### AC3: Variables Persist in State.yaml

**Test Focus**: YAML serialization, atomic writes, backup, corruption recovery

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ------------- | ----------- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.3-UNIT-012  | Unit        | P0       | Serialize variables to YAML format               | Core persistence logic                 | DATA-001       |
| 3.3-UNIT-013  | Unit        | P0       | Deserialize variables from YAML                  | Core load logic                        | DATA-001       |
| 3.3-UNIT-014  | Unit        | P0       | Preserve type information through round-trip     | Type safety                            | DATA-002       |
| 3.3-UNIT-015  | Unit        | P1       | Handle empty state (new instance)                | Edge case                              | OPS-001        |
| 3.3-UNIT-016  | Unit        | P1       | Handle missing variables field in legacy state   | Backward compatibility                 | OPS-001        |
| 3.3-INT-006   | Integration | P0       | Atomic file write (tmp → fsync → rename)         | Prevents corruption                    | DATA-001       |
| 3.3-INT-007   | Integration | P0       | Create backup before state save                  | Recovery capability                    | DATA-001       |
| 3.3-INT-008   | Integration | P0       | Recover from corrupted state using backup        | Data integrity                         | DATA-001       |
| 3.3-INT-009   | Integration | P0       | Prevent concurrent writes with file locking      | Concurrency safety                     | DATA-001       |
| 3.3-INT-010   | Integration | P1       | Persist and load complex variable structures     | Real-world scenario                    | -              |
| 3.3-INT-011   | Integration | P2       | Handle filesystem errors gracefully              | Error resilience                       | -              |

**Total AC3**: 11 tests (5 unit, 6 integration)

---

### AC4: Global and Step-Level Scope

**Test Focus**: Scope resolution, override behavior, inheritance

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                       | Justification                   | Mitigates Risk |
| ------------- | ----------- | -------- | --------------------------------------------------- | ------------------------------- | -------------- |
| 3.3-UNIT-017  | Unit        | P0       | Resolve variable from global scope                  | Core scope logic                | TECH-001       |
| 3.3-UNIT-018  | Unit        | P0       | Resolve variable from step scope                    | Core scope logic                | TECH-001       |
| 3.3-UNIT-019  | Unit        | P0       | Step scope overrides global scope                   | Priority resolution critical    | TECH-001       |
| 3.3-UNIT-020  | Unit        | P1       | Handle undefined variable in both scopes            | Error handling                  | -              |
| 3.3-UNIT-021  | Unit        | P2       | Warn on shadowed variables                          | Developer experience            | TECH-001       |
| 3.3-INT-012   | Integration | P1       | Set and get variables in multiple scopes            | Multi-scope interaction         | TECH-001       |
| 3.3-INT-013   | Integration | P1       | Scope inheritance for nested steps (if applicable)  | Complex scenario                | TECH-001       |
| 3.3-INT-014   | Integration | P2       | Clear step scope without affecting global           | Isolation correctness           | -              |

**Total AC4**: 8 tests (5 unit, 3 integration)

---

### AC5: Variable Editor in TUI

**Test Focus**: TUI component integration, user editing workflow

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                    | Justification                  | Mitigates Risk |
| ------------- | ----------- | -------- | ------------------------------------------------ | ------------------------------ | -------------- |
| 3.3-INT-015   | Integration | P1       | Display variable list in TUI                     | Core TUI functionality         | -              |
| 3.3-INT-016   | Integration | P1       | Edit existing variable value via TUI             | Primary user interaction       | -              |
| 3.3-INT-017   | Integration | P1       | Add new variable via TUI editor                  | User capability                | -              |
| 3.3-INT-018   | Integration | P2       | Delete variable via TUI editor                   | Secondary functionality        | -              |
| 3.3-INT-019   | Integration | P2       | Validate variable changes in TUI before save     | UX quality                     | -              |
| 3.3-E2E-002   | E2E         | P1       | User edits variables and persists changes        | Critical user journey          | -              |

**Total AC5**: 6 tests (5 integration, 1 e2e)

---

### AC6: Environment Variable Access

**Test Focus**: Security allowlist, type conversion, audit logging

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                           | Justification                       | Mitigates Risk |
| ------------- | ----------- | -------- | ------------------------------------------------------- | ----------------------------------- | -------------- |
| 3.3-UNIT-022  | Unit        | P0       | Resolve allowed environment variable (HOME, USER, etc.) | Core functionality                  | SEC-002        |
| 3.3-UNIT-023  | Unit        | P0       | Block disallowed environment variable                   | Critical security control           | SEC-002        |
| 3.3-UNIT-024  | Unit        | P0       | Block variables matching dangerous patterns             | Pattern-based security              | SEC-002        |
| 3.3-UNIT-025  | Unit        | P0       | Convert env var string to appropriate type              | Type safety                         | -              |
| 3.3-UNIT-026  | Unit        | P1       | Return default value if env var not found               | Fallback behavior                   | -              |
| 3.3-UNIT-027  | Unit        | P1       | Parse $ENV: prefix correctly                            | Syntax correctness                  | -              |
| 3.3-INT-020   | Integration | P0       | Log all environment variable access attempts            | Security audit trail                | SEC-002        |
| 3.3-INT-021   | Integration | P0       | Security test: Attempt access to AWS_SECRET_KEY         | Real-world attack simulation        | SEC-002        |

**Total AC6**: 8 tests (6 unit, 2 integration)

---

### AC7: Computed Variables with Expressions

**Test Focus**: Safe expression evaluation, circular dependency detection, caching

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                              | Justification                              | Mitigates Risk |
| ------------- | ----------- | -------- | ---------------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.3-UNIT-028  | Unit        | P0       | Evaluate simple arithmetic expression (a + b)              | Core computation                           | -              |
| 3.3-UNIT-029  | Unit        | P0       | Evaluate string interpolation (\`${var}\`)                 | Common use case                            | -              |
| 3.3-UNIT-030  | Unit        | P0       | Evaluate boolean logic (a && b)                            | Logic operations                           | -              |
| 3.3-UNIT-031  | Unit        | P0       | Evaluate comparison operators (a > b)                      | Comparison logic                           | -              |
| 3.3-UNIT-032  | Unit        | P0       | Detect circular dependency (A → B → A)                     | **Critical risk mitigation**               | DATA-003       |
| 3.3-UNIT-033  | Unit        | P0       | Detect circular dependency (A → B → C → A)                 | **Critical risk mitigation**               | DATA-003       |
| 3.3-UNIT-034  | Unit        | P0       | Detect self-referencing variable (A → A)                   | **Critical risk mitigation**               | DATA-003       |
| 3.3-UNIT-035  | Unit        | P0       | Block sandbox escape attempt (require('fs'))               | **Critical security mitigation**           | SEC-001        |
| 3.3-UNIT-036  | Unit        | P0       | Block access to Bun runtime (Bun.file)                     | **Critical security mitigation**           | SEC-001        |
| 3.3-UNIT-037  | Unit        | P0       | Block access to process object                             | **Critical security mitigation**           | SEC-001        |
| 3.3-UNIT-038  | Unit        | P0       | Enforce timeout on infinite loop expression                | **Critical security mitigation**           | SEC-001        |
| 3.3-UNIT-039  | Unit        | P0       | Enforce memory limit on memory bomb                        | **Critical security mitigation**           | SEC-001        |
| 3.3-UNIT-040  | Unit        | P1       | Cache computed variable result                             | Performance optimization                   | PERF-002       |
| 3.3-UNIT-041  | Unit        | P1       | Invalidate cache on dependency change                      | Cache correctness                          | PERF-002       |
| 3.3-UNIT-042  | Unit        | P1       | Resolve nested dependencies (A → B → C)                    | Complex scenario                           | -              |
| 3.3-INT-022   | Integration | P0       | Evaluate expression with dependencies from VariableStore   | Integration with storage                   | -              |
| 3.3-INT-023   | Integration | P0       | Security fuzzing: 1000+ malicious expressions              | **Critical security validation**           | SEC-001        |
| 3.3-INT-024   | Integration | P1       | Complex dependency chain (10 levels deep)                  | Stress test dependency resolution          | PERF-001       |
| 3.3-E2E-003   | E2E         | P0       | User defines computed variable and sees evaluated result   | Critical user journey                      | -              |

**Total AC7**: 19 tests (15 unit, 3 integration, 1 e2e)

---

### AC8: Type Validation (String, Number, Boolean, Array)

**Test Focus**: Type validators, validation rules, edge cases

#### Scenarios

| ID            | Level       | Priority | Test Scenario                                       | Justification                  | Mitigates Risk |
| ------------- | ----------- | -------- | --------------------------------------------------- | ------------------------------ | -------------- |
| 3.3-UNIT-043  | Unit        | P0       | Validate string type                                | Core type validation           | DATA-002       |
| 3.3-UNIT-044  | Unit        | P0       | Validate number type                                | Core type validation           | DATA-002       |
| 3.3-UNIT-045  | Unit        | P0       | Validate boolean type                               | Core type validation           | DATA-002       |
| 3.3-UNIT-046  | Unit        | P0       | Validate array type                                 | Core type validation           | DATA-002       |
| 3.3-UNIT-047  | Unit        | P0       | Reject invalid type (string when number expected)   | Type safety                    | DATA-002       |
| 3.3-UNIT-048  | Unit        | P1       | Validate string pattern (regex)                     | Advanced validation            | SEC-003        |
| 3.3-UNIT-049  | Unit        | P1       | Validate number min/max                             | Range validation               | -              |
| 3.3-UNIT-050  | Unit        | P1       | Validate string/array length min/max                | Length validation              | -              |
| 3.3-UNIT-051  | Unit        | P1       | Validate enum values                                | Constrained values             | -              |
| 3.3-UNIT-052  | Unit        | P2       | Handle edge case: null value                        | Edge case                      | DATA-002       |
| 3.3-UNIT-053  | Unit        | P2       | Handle edge case: undefined value                   | Edge case                      | DATA-002       |
| 3.3-UNIT-054  | Unit        | P2       | Handle edge case: NaN for number                    | Edge case                      | DATA-002       |
| 3.3-UNIT-055  | Unit        | P2       | Handle edge case: empty array                       | Edge case                      | -              |

**Total AC8**: 13 tests (13 unit)

---

## Additional Test Categories

### Performance Tests

| ID            | Level       | Priority | Test Scenario                                       | Justification                  | Mitigates Risk |
| ------------- | ----------- | -------- | --------------------------------------------------- | ------------------------------ | -------------- |
| 3.3-PERF-001  | Integration | P0       | Variable lookup: <1ms average (1000 iterations)     | Performance requirement        | PERF-001       |
| 3.3-PERF-002  | Integration | P0       | Computed variable evaluation: <5ms simple expr      | Performance requirement        | PERF-001       |
| 3.3-PERF-003  | Integration | P0       | State persistence: <10ms for 100 variables          | Performance requirement        | -              |
| 3.3-PERF-004  | Integration | P1       | Cache hit rate: >80% in typical usage               | Caching effectiveness          | PERF-002       |

**Total Performance**: 4 tests (4 integration)

### Audit & Logging Tests

| ID            | Level       | Priority | Test Scenario                                         | Justification             | Mitigates Risk |
| ------------- | ----------- | -------- | ----------------------------------------------------- | ------------------------- | -------------- |
| 3.3-INT-025   | Integration | P1       | Verify structured logging for variable.get            | Audit trail completeness  | OPS-002        |
| 3.3-INT-026   | Integration | P1       | Verify structured logging for variable.set            | Audit trail completeness  | OPS-002        |
| 3.3-INT-027   | Integration | P1       | Verify audit log for computed variable evaluation     | Security monitoring       | OPS-002        |
| 3.3-E2E-004   | E2E         | P2       | End-to-end audit trail for variable lifecycle         | Compliance validation     | OPS-002        |

**Total Audit**: 4 tests (3 integration, 1 e2e)

---

## Risk Coverage Matrix

Mapping test scenarios to identified risks from risk profile:

| Risk ID  | Risk Description                        | Test Coverage IDs                                              | Coverage Level |
| -------- | --------------------------------------- | -------------------------------------------------------------- | -------------- |
| SEC-001  | Computed expression sandbox escape      | 3.3-UNIT-035 to 039, 3.3-INT-023                               | **Excellent**  |
| DATA-003 | Circular dependency infinite loop       | 3.3-UNIT-032 to 034                                            | **Excellent**  |
| SEC-002  | Environment variable exposure           | 3.3-UNIT-022 to 024, 3.3-INT-020, 021                          | **Excellent**  |
| DATA-001 | Variable state corruption               | 3.3-UNIT-012 to 014, 3.3-INT-006 to 009                        | **Excellent**  |
| TECH-002 | Variable prompting UX integration       | 3.3-INT-003 to 005, 3.3-E2E-001                                | **Good**       |
| PERF-001 | Computed variable eval performance      | 3.3-PERF-001, 002, 3.3-INT-024                                 | **Good**       |
| SEC-003  | Variable injection in templates         | 3.3-UNIT-008, 048                                              | Adequate       |
| TECH-001 | Scope resolution complexity             | 3.3-UNIT-017 to 021, 3.3-INT-012 to 014                        | **Good**       |
| TECH-003 | Sandbox resource limit enforcement      | 3.3-UNIT-038, 039                                              | Adequate       |
| PERF-002 | Variable lookup cache invalidation      | 3.3-UNIT-040, 041, 3.3-PERF-004                                | **Good**       |
| DATA-002 | Variable type coercion loss             | 3.3-UNIT-001, 002, 014, 043-047, 052-054                       | **Excellent**  |
| OPS-001  | Variable state migration path           | 3.3-UNIT-015, 016                                              | Adequate       |
| OPS-002  | Audit logging gaps                      | 3.3-INT-025 to 027, 3.3-E2E-004                                | **Good**       |

**Risk Coverage Assessment**: All critical and high risks have **Excellent** or **Good** test coverage. Medium and low risks have adequate coverage appropriate to their severity.

---

## Test Coverage by Acceptance Criteria

| AC  | Description                            | Unit | Integration | E2E | Total | P0  | P1  | P2  |
| --- | -------------------------------------- | ---- | ----------- | --- | ----- | --- | --- | --- |
| 1   | Variables defined with types/defaults  | 5    | 2           | 0   | 7     | 2   | 3   | 2   |
| 2   | Required variables prompted            | 6    | 3           | 1   | 10    | 4   | 4   | 2   |
| 3   | Variables persist in state.yaml        | 5    | 6           | 0   | 11    | 7   | 3   | 1   |
| 4   | Global and step-level scope            | 5    | 3           | 0   | 8     | 3   | 3   | 2   |
| 5   | Variable editor in TUI                 | 0    | 5           | 1   | 6     | 0   | 4   | 2   |
| 6   | Environment variable access            | 6    | 2           | 0   | 8     | 6   | 2   | 0   |
| 7   | Computed variables with expressions    | 15   | 3           | 1   | 19    | 13  | 4   | 2   |
| 8   | Type validation                        | 13   | 0           | 0   | 13    | 6   | 4   | 3   |
| -   | Performance tests                      | 0    | 4           | 0   | 4     | 3   | 1   | 0   |
| -   | Audit & logging tests                  | 0    | 3           | 1   | 4     | 0   | 3   | 1   |

**Totals**: 55 unit, 31 integration, 4 e2e = **90 tests**
**Priorities**: 44 P0, 31 P1, 15 P2

---

## Test Execution Strategy

### Phase 1: Fast Feedback (P0 Unit Tests)

Execute all P0 unit tests first to catch logic errors early:

- **Target**: <30 seconds execution time
- **Coverage**: Critical business logic, security controls, type validation
- **Fail fast**: Any P0 unit test failure blocks further testing

**Key tests**:
- All circular dependency detection (3.3-UNIT-032 to 034)
- All sandbox security tests (3.3-UNIT-035 to 039)
- All environment variable security (3.3-UNIT-022 to 024)
- Type validation core (3.3-UNIT-043 to 047)

### Phase 2: Integration Validation (P0 Integration)

Execute P0 integration tests to validate component interactions:

- **Target**: <2 minutes execution time
- **Coverage**: Persistence, security, TUI integration
- **Critical paths**: State corruption prevention, security fuzzing

**Key tests**:
- Atomic file writes and backup (3.3-INT-006 to 009)
- Security fuzzing suite (3.3-INT-023)
- Environment variable audit logging (3.3-INT-020, 021)
- Performance benchmarks (3.3-PERF-001 to 003)

### Phase 3: User Journeys (E2E)

Execute critical user journeys end-to-end:

- **Target**: <5 minutes execution time
- **Coverage**: Full user workflows with real TUI

**Key tests**:
- User init with variable prompting (3.3-E2E-001)
- User edits variables via TUI (3.3-E2E-002)
- User creates computed variable (3.3-E2E-003)

### Phase 4: Extended Coverage (P1/P2)

Execute P1 and P2 tests for comprehensive coverage:

- **Target**: <10 minutes total
- **Coverage**: Edge cases, secondary features, polish

---

## Test Level Justification Summary

### Why Heavy Unit Test Focus (62.7%)?

1. **Pure Logic Dominance**: Variable system is algorithm-heavy (type validation, scope resolution, circular dependency detection, expression evaluation)
2. **Fast Feedback**: Unit tests run in milliseconds, enabling rapid iteration
3. **Security Critical**: Sandbox security and circular dependency detection require exhaustive unit testing
4. **Low External Dependencies**: Most logic is self-contained and doesn't require database or UI

### Why Moderate Integration Tests (31.3%)?

1. **Persistence Layer**: YAML serialization and atomic writes require filesystem interaction
2. **Component Boundaries**: Variable store ↔ Sandbox, Variable store ↔ TUI interfaces
3. **Security Validation**: Real-world attack simulation (fuzzing, env var attempts)
4. **Performance Benchmarks**: Must test with real infrastructure

### Why Minimal E2E Tests (6.0%)?

1. **Tested at Lower Levels**: Most functionality thoroughly covered by unit/integration
2. **Slow and Brittle**: E2E tests expensive to maintain and slow to execute
3. **Critical Paths Only**: Focus on revenue-critical user journeys (init, edit, computed)
4. **Risk-Based**: Story has no payment/financial flows requiring extensive E2E

---

## Test Data Requirements

### Mock Data Needed

**Variable Definitions**:
```typescript
- Simple string variable (required, with default)
- Number variable with min/max validation
- Boolean variable
- Array variable with length constraints
- Computed variable with 2 dependencies
- Computed variable with circular dependency (for negative testing)
- Variable with pattern validation (regex)
- Variable with enum values
```

**State Files**:
```yaml
- Empty state (new instance)
- State with global variables only
- State with step variables only
- State with both global and step variables
- Legacy state without variables field
- Corrupted state file (invalid YAML)
```

**Malicious Expressions** (for security testing):
```javascript
- require('fs').readFileSync('/etc/passwd')
- Bun.file('/etc/passwd').text()
- process.exit(1)
- new Function('return process')()
- constructor.constructor('return process')()
- __proto__.isAdmin = true
- while(true) {} // infinite loop
- 'x'.repeat(1e9) // memory bomb
```

### Test Data Factory Extensions

Extend `TestDataFactory` with variable-specific generators:

```typescript
TestDataFactory.createVariableDefinition(overrides)
TestDataFactory.createComputedVariable(expression, dependencies)
TestDataFactory.createVariableState(globalVars, stepVars)
TestDataFactory.createMaliciousExpression(attackType)
```

---

## Coverage Gap Analysis

### Gaps Identified

None - all acceptance criteria have comprehensive test coverage.

### Over-Coverage Assessment

**Potential Over-Testing**:
- 13 type validation tests (3.3-UNIT-043 to 055) may be excessive
- **Recommendation**: Keep all P0/P1, consolidate P2 edge cases into parameterized test

**Justification for Keeping**:
- Type validation is foundational - bugs here cascade
- Edge cases (null, undefined, NaN) historically problematic in JavaScript
- **Verdict**: Keep current coverage

---

## Test Maintenance Considerations

### High Maintenance Risk

**3.3-INT-023**: Security fuzzing with 1000+ expressions
- **Risk**: Slow execution, flaky failures
- **Mitigation**: Run in separate performance suite, use seeded random generation

**E2E Tests**: TUI interaction brittle
- **Risk**: Breaks on UI changes
- **Mitigation**: Use page object pattern, abstract TUI interactions

### Low Maintenance Risk

**Unit tests**: All highly stable
- **Reason**: Pure functions, no external dependencies
- **Maintenance**: Minimal expected

---

## Recommended Test Tools

### Unit Testing

- **Framework**: Bun Test (native, fast)
- **Mocking**: Built-in Bun mocks
- **Assertions**: Expect API (Bun-compatible)

### Integration Testing

- **Filesystem**: Use tmp directories, cleanup after
- **Locking**: Test with `proper-lockfile` library
- **Performance**: Use `Bun.nanoseconds()` for precision

### E2E Testing

- **TUI Simulation**: Use blessed/ink test utilities
- **Snapshot Testing**: Capture TUI output snapshots
- **Async Handling**: Use Bun's native async/await

### Security Testing

- **Fuzzing**: Custom fuzzer with known attack patterns
- **OWASP Payloads**: Import from OWASP repository
- **Static Analysis**: ESLint security rules

---

## Success Criteria

### Test Pass Criteria

- **All P0 tests**: 100% pass rate (mandatory)
- **All P1 tests**: 100% pass rate (mandatory)
- **P2 tests**: 95%+ pass rate (acceptable)
- **Performance tests**: Must meet targets (<1ms, <5ms, <10ms)

### Coverage Criteria

- **Unit test coverage**: >90% (aligns with Core package requirement)
- **Integration test coverage**: >80%
- **E2E test coverage**: Critical paths only (no coverage %)

### Mutation Testing

- **Mutation score**: >85% (StrykerJS)
- **Focus**: ComputedVariableEngine, VariableValidator, circular dependency detection

---

## Test Schedule

### Implementation Phasing

**Week 1**: P0 unit tests (all critical business logic)
**Week 2**: P0 integration tests (persistence, security)
**Week 3**: P1 unit and integration tests
**Week 4**: E2E tests, P2 tests, mutation testing

### Execution Frequency

- **P0 tests**: Every commit (pre-commit hook)
- **P1 tests**: Every PR (CI/CD pipeline)
- **P2 tests**: Daily regression
- **E2E tests**: Pre-release only (too slow for frequent runs)

---

## Quality Gate Integration

This test design integrates with the quality gate as follows:

**Gate Criteria**:
- All P0 tests pass → Required for PASS gate
- All P1 tests pass → Required for PASS gate
- Performance targets met → Required for PASS gate
- Mutation score >85% → Required for PASS gate

**Gate Decision Mapping**:
- Any P0 test failure → **FAIL** gate
- P1 test failures + unmitigated critical risk → **FAIL** gate
- P1 test failures without critical risk → **CONCERNS** gate
- All P0/P1 pass, P2 failures → **PASS** gate (acceptable)

---

## Continuous Improvement

### Post-Implementation Review

After story completion, evaluate:

1. **Test effectiveness**: Did tests catch bugs?
2. **Execution time**: Did we meet <30s unit, <2m integration targets?
3. **False positives**: Were any tests flaky?
4. **Coverage gaps**: Did production reveal untested scenarios?

### Adjustment Triggers

Increase test coverage if:
- Production incidents in variable system
- Security vulnerabilities discovered
- Performance degradation reported

Reduce test coverage if:
- Redundant coverage identified
- Maintenance burden excessive
- Execution time too slow

---

## Conclusion

This test design provides **comprehensive coverage** of Story 3.3 with appropriate test levels and priorities. The heavy emphasis on unit testing (62.7%) aligns with the algorithm-heavy nature of the variable system, while integration tests (31.3%) cover critical persistence and security scenarios. Minimal E2E tests (6.0%) focus on critical user journeys.

**Key Strengths**:
- All critical risks (SEC-001, DATA-003, SEC-002, DATA-001) have excellent test coverage
- Test pyramid correctly shaped (wide base of unit tests)
- Performance benchmarks built in
- Security testing comprehensive (fuzzing, allowlist validation)

**Estimated Effort**:
- Test implementation: 4-5 weeks
- Maintenance: Low (stable unit tests)
- Execution time: <10 minutes full suite

**Recommendation**: Approve this test design and proceed with implementation per phasing schedule.

---

**Designed by**: Quinn (Test Architect)
**Version**: 1.0
**Next review**: After Task 8 (Write comprehensive tests) implementation
