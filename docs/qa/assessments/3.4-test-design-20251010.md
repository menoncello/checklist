# Test Design: Story 3.4 - Basic Template Substitution

**Date**: 2025-10-10
**Designer**: Quinn (Test Architect)
**Story ID**: 3.4
**Story Title**: Basic Template Substitution

---

## Test Strategy Overview

- **Total test scenarios**: 68
- **Unit tests**: 52 (76%)
- **Integration tests**: 14 (21%)
- **E2E tests**: 2 (3%)
- **Priority distribution**: P0: 28, P1: 24, P2: 12, P3: 4

**Test Strategy Rationale**:
This story implements a critical template substitution system with significant security and performance risks (see risk profile: `docs/qa/assessments/3.4-risk-20251010.md`). The test strategy prioritizes:

1. **Security testing** (P0): Injection prevention, input validation, escape handling
2. **Performance testing** (P0): <5ms requirement for typical templates (AC 8)
3. **Algorithm correctness** (P0/P1): Core substitution logic, nested resolution, defaults
4. **Integration validation** (P1): VariableStore, TemplateEngine, ComputedVariableEngine
5. **User experience** (P2): Error messages, preview functionality

**Test Level Distribution Justification**:
- **76% Unit**: Substitution logic is primarily algorithmic (regex, string manipulation, recursion) - ideal for unit testing
- **21% Integration**: Critical integration points with VariableStore (Story 3.3) and TemplateEngine (Story 3.1)
- **3% E2E**: Minimal E2E needed; most functionality testable at lower levels with better performance/maintainability

---

## Test Scenarios by Acceptance Criteria

### AC 1: ${variable} substitution works

**Risk Coverage**: DATA-001 (Type Handling), TECH-001 (VariableStore Integration)

#### Unit Test Scenarios

| ID            | Level | Priority | Test Scenario                                    | Justification                              | Mitigates Risk |
| ------------- | ----- | -------- | ------------------------------------------------ | ------------------------------------------ | -------------- |
| 3.4-UNIT-001  | Unit  | P0       | Simple variable substitution: `${name}` → value | Core functionality, must work              | -              |
| 3.4-UNIT-002  | Unit  | P0       | Multiple variables in single template            | Common use case                            | -              |
| 3.4-UNIT-003  | Unit  | P0       | String variable substitution                     | Most common type                           | DATA-001       |
| 3.4-UNIT-004  | Unit  | P0       | Number variable substitution                     | Type conversion correctness                | DATA-001       |
| 3.4-UNIT-005  | Unit  | P0       | Boolean variable substitution                    | Type conversion (true/false as string)     | DATA-001       |
| 3.4-UNIT-006  | Unit  | P0       | Array variable substitution with join            | Complex type handling                      | DATA-001       |
| 3.4-UNIT-007  | Unit  | P1       | Empty string variable (should not use default)   | Edge case: empty vs undefined              | DATA-001       |
| 3.4-UNIT-008  | Unit  | P1       | Variable at start of template: `${var}text`      | Position boundary                          | -              |
| 3.4-UNIT-009  | Unit  | P1       | Variable at end of template: `text${var}`        | Position boundary                          | -              |
| 3.4-UNIT-010  | Unit  | P1       | Variable with only content: `${var}`             | Minimal template                           | -              |
| 3.4-UNIT-011  | Unit  | P1       | Adjacent variables: `${var1}${var2}`             | No separator between variables             | -              |
| 3.4-UNIT-012  | Unit  | P2       | Variable with hyphen in name: `${my-var}`        | Allowed character validation               | -              |
| 3.4-UNIT-013  | Unit  | P2       | Variable with underscore: `${my_var}`            | Allowed character validation               | -              |
| 3.4-UNIT-014  | Unit  | P2       | Variable with dot: `${config.value}`             | Allowed character validation               | -              |
| 3.4-UNIT-015  | Unit  | P2       | Variable name with numbers: `${var123}`          | Allowed character validation               | -              |
| 3.4-UNIT-016  | Unit  | P0       | Number edge case: NaN substitution               | Must not crash, format as "NaN"            | DATA-001       |
| 3.4-UNIT-017  | Unit  | P0       | Number edge case: Infinity substitution          | Must not crash, format as "Infinity"       | DATA-001       |
| 3.4-UNIT-018  | Unit  | P0       | Number edge case: -Infinity substitution         | Must not crash, format as "-Infinity"      | DATA-001       |
| 3.4-UNIT-019  | Unit  | P1       | Number edge case: -0 substitution                | Special number handling                    | DATA-001       |
| 3.4-UNIT-020  | Unit  | P1       | Array with mixed types: `[1, "two", true]`       | Mixed type array join                      | DATA-001       |
| 3.4-UNIT-021  | Unit  | P1       | Empty array substitution: `[]` → `""`            | Empty array edge case                      | DATA-001       |
| 3.4-UNIT-022  | Unit  | P1       | Single-element array: `[1]` → `"1"`              | No comma for single element                | DATA-002       |
| 3.4-UNIT-023  | Unit  | P2       | Large array (100 items) substitution             | Performance and memory concern             | DATA-001       |
| 3.4-UNIT-024  | Unit  | P3       | Very large array (1000 items) warning            | Should log warning                         | DATA-001       |

#### Integration Test Scenarios

| ID           | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.4-INT-001  | Integration | P0       | Variable resolution via VariableStore.get()      | Critical dependency on Story 3.3       | TECH-001       |
| 3.4-INT-002  | Integration | P0       | Global scope variable substitution               | Scope resolution via VariableStore     | TECH-001       |
| 3.4-INT-003  | Integration | P0       | Step-level scope variable substitution           | Step scope override via VariableStore  | TECH-001       |
| 3.4-INT-004  | Integration | P1       | Step-level variable overrides global             | Scope resolution priority              | TECH-001       |

---

### AC 2: Nested variables: ${var1.${var2}}

**Risk Coverage**: PERF-001 (Nested Performance - CRITICAL)

#### Unit Test Scenarios

| ID           | Level | Priority | Test Scenario                                                     | Justification                                 | Mitigates Risk |
| ------------ | ----- | -------- | ----------------------------------------------------------------- | --------------------------------------------- | -------------- |
| 3.4-UNIT-025 | Unit  | P0       | Single-level nesting: `${base.${key}}`                            | Basic nested functionality                    | -              |
| 3.4-UNIT-026 | Unit  | P0       | Two-level nesting: `${a${b${c}}}`                                 | Multi-level recursion                         | PERF-001       |
| 3.4-UNIT-027 | Unit  | P0       | Three-level nesting                                               | Deeper recursion test                         | PERF-001       |
| 3.4-UNIT-028 | Unit  | P0       | Maximum nesting depth (5 levels)                                  | Maximum allowed depth                         | PERF-001       |
| 3.4-UNIT-029 | Unit  | P0       | Exceed maximum nesting depth (6 levels) - error                   | Must enforce limit                            | PERF-001       |
| 3.4-UNIT-030 | Unit  | P1       | Nested variable in middle of template                             | Position independence                         | -              |
| 3.4-UNIT-031 | Unit  | P1       | Multiple nested variables in one template                         | Multiple recursion points                     | PERF-001       |
| 3.4-UNIT-032 | Unit  | P0       | Circular reference detection: `${a}` refs `${b}`, `${b}` refs `${a}` | Must prevent infinite loop                    | PERF-001       |
| 3.4-UNIT-033 | Unit  | P1       | Self-referencing variable: `${var}` contains `${var}`             | Circular reference edge case                  | PERF-001       |
| 3.4-UNIT-034 | Unit  | P1       | Nested variable resolves to undefined (inner)                     | Error handling in nested context              | -              |
| 3.4-UNIT-035 | Unit  | P1       | Nested variable resolves to undefined (outer)                     | Error handling after inner resolution         | -              |

#### Performance Test Scenarios (Benchmarks)

| ID            | Level | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ------------- | ----- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.4-PERF-001  | Unit  | P0       | Nested substitution (depth 5) completes <10ms    | AC 8 performance requirement           | PERF-001       |
| 3.4-PERF-002  | Unit  | P0       | Pathological nesting (100 vars, depth 5) <20ms   | Worst-case performance validation      | PERF-001       |

---

### AC 3: Default values: ${var:-default}

**Risk Coverage**: None specific

#### Unit Test Scenarios

| ID           | Level | Priority | Test Scenario                                           | Justification                              | Mitigates Risk |
| ------------ | ----- | -------- | ------------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-UNIT-036 | Unit  | P0       | Default value used when variable undefined              | Core default functionality                 | -              |
| 3.4-UNIT-037 | Unit  | P0       | Default value NOT used when variable defined            | Default only for undefined                 | -              |
| 3.4-UNIT-038 | Unit  | P1       | Empty string does NOT trigger default                   | Empty string is valid value                | -              |
| 3.4-UNIT-039 | Unit  | P1       | Zero (0) does NOT trigger default                       | Zero is valid value                        | -              |
| 3.4-UNIT-040 | Unit  | P1       | False (boolean) does NOT trigger default                | False is valid value                       | -              |
| 3.4-UNIT-041 | Unit  | P1       | Default value with special characters                   | Default can contain any characters         | -              |
| 3.4-UNIT-042 | Unit  | P1       | Default value with spaces: `${var:- default value }`    | Whitespace handling in defaults            | -              |
| 3.4-UNIT-043 | Unit  | P2       | Nested variable in default: `${var1:-${var2}}`          | Default can be variable reference          | -              |
| 3.4-UNIT-044 | Unit  | P2       | Nested default fallback chain: `${v1:-${v2:-fallback}}` | Multiple levels of defaults                | -              |
| 3.4-UNIT-045 | Unit  | P2       | Empty default value: `${var:-}`                         | Default to empty string explicitly         | -              |
| 3.4-UNIT-046 | Unit  | P3       | Very long default value (1000 chars)                    | Should not cause performance issues        | -              |

---

### AC 4: Escaping: \${literal}

**Risk Coverage**: TECH-002 (Escape Edge Cases)

#### Unit Test Scenarios

| ID           | Level | Priority | Test Scenario                                         | Justification                              | Mitigates Risk |
| ------------ | ----- | -------- | ----------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-UNIT-047 | Unit  | P0       | Single escape: `\${var}` → `${var}` (literal)         | Core escape functionality                  | TECH-002       |
| 3.4-UNIT-048 | Unit  | P0       | Double escape: `\\${var}` → `\value`                  | Escape the escape                          | TECH-002       |
| 3.4-UNIT-049 | Unit  | P1       | Triple escape: `\\\${var}` → `\${var}` (literal)      | Complex escape sequence                    | TECH-002       |
| 3.4-UNIT-050 | Unit  | P1       | Mixed escaped and unescaped: `\${lit} ${var}`         | Combination handling                       | TECH-002       |
| 3.4-UNIT-051 | Unit  | P1       | Escape in default value: `${var:-\${default}}`        | Escape within default syntax               | TECH-002       |
| 3.4-UNIT-052 | Unit  | P1       | Multiple escaped variables in template                | Multiple escape points                     | TECH-002       |
| 3.4-UNIT-053 | Unit  | P2       | Backslash before non-variable: `\text`                | Backslash not before ${                    | TECH-002       |
| 3.4-UNIT-054 | Unit  | P2       | Escape at start of template: `\${var}text`            | Position edge case                         | TECH-002       |
| 3.4-UNIT-055 | Unit  | P2       | Escape at end of template: `text\${var}`              | Position edge case                         | TECH-002       |

---

### AC 5: All string operations safe

**Risk Coverage**: SEC-001 (Injection Attacks - CRITICAL), SEC-002 (ReDoS)

#### Security Test Scenarios (Unit)

| ID           | Level | Priority | Test Scenario                                               | Justification                              | Mitigates Risk |
| ------------ | ----- | -------- | ----------------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-SEC-001  | Unit  | P0       | Reject variable name with semicolon: `${cmd;}`              | Command injection prevention               | SEC-001        |
| 3.4-SEC-002  | Unit  | P0       | Reject variable name with pipe: `${cmd\|}`                  | Command injection prevention               | SEC-001        |
| 3.4-SEC-003  | Unit  | P0       | Reject variable name with backtick: ``${cmd`}``             | Command injection prevention               | SEC-001        |
| 3.4-SEC-004  | Unit  | P0       | Reject variable name with dollar: `${$var}`                 | Variable injection prevention              | SEC-001        |
| 3.4-SEC-005  | Unit  | P0       | Reject variable name with parens: `${cmd()}`                | Function call injection prevention         | SEC-001        |
| 3.4-SEC-006  | Unit  | P0       | Reject variable name with brackets: `${arr[]}`              | Array access injection prevention          | SEC-001        |
| 3.4-SEC-007  | Unit  | P0       | Reject variable name with braces: `${obj{}}`                | Object access injection prevention         | SEC-001        |
| 3.4-SEC-008  | Unit  | P0       | Reject variable name with angle brackets: `${<script>}`     | XSS injection prevention                   | SEC-001        |
| 3.4-SEC-009  | Unit  | P0       | SQL injection attempt in value: `'; DROP TABLE--`           | Value sanitization                         | SEC-001        |
| 3.4-SEC-010  | Unit  | P0       | XSS attempt in value: `<script>alert(1)</script>`           | HTML sanitization                          | SEC-001        |
| 3.4-SEC-011  | Unit  | P0       | Command injection in value: `; cat /etc/passwd`             | Shell command sanitization                 | SEC-001        |
| 3.4-SEC-012  | Unit  | P0       | Path traversal in value: `../../etc/passwd`                 | Path injection prevention                  | SEC-001        |
| 3.4-SEC-013  | Unit  | P0       | Null byte injection: `${var}\x00malicious`                  | Null byte sanitization                     | SEC-001        |
| 3.4-SEC-014  | Unit  | P0       | Variable name exceeds 128 characters - reject               | DoS prevention                             | SEC-001        |
| 3.4-SEC-015  | Unit  | P0       | Template exceeds 10,000 characters - reject                 | DoS prevention                             | SEC-002        |
| 3.4-SEC-016  | Unit  | P0       | ReDoS pattern: `(a+)+b` in variable name - timeout          | ReDoS prevention                           | SEC-002        |
| 3.4-SEC-017  | Unit  | P0       | Regex catastrophic backtracking - timeout triggers          | ReDoS prevention                           | SEC-002        |
| 3.4-SEC-018  | Unit  | P0       | Default value exceeds 1,000 characters - reject             | DoS prevention                             | SEC-002        |
| 3.4-SEC-019  | Unit  | P1       | Audit log generated for suspicious variable names           | Security monitoring                        | SEC-001        |
| 3.4-SEC-020  | Unit  | P1       | Audit log generated for special characters in values        | Security monitoring                        | SEC-001        |
| 3.4-SEC-021  | Unit  | P0       | No eval() used anywhere in implementation                   | Code audit verification                    | SEC-001        |
| 3.4-SEC-022  | Unit  | P0       | No Function() constructor used                              | Code audit verification                    | SEC-001        |
| 3.4-SEC-023  | Unit  | P0       | No template literals with user input                        | Code audit verification                    | SEC-001        |
| 3.4-SEC-024  | Unit  | P1       | Variable name validation uses allowlist pattern             | Positive security model                    | SEC-001        |

#### Security Integration Tests

| ID          | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ----------- | ----------- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.4-INT-005 | Integration | P0       | OWASP Top 10 injection payloads - all rejected   | Comprehensive injection test suite     | SEC-001        |
| 3.4-INT-006 | Integration | P0       | Penetration testing with OWASP ZAP - no issues   | Automated security scanning            | SEC-001        |

---

### AC 6: Clear error messages for undefined

**Risk Coverage**: OPS-001 (Error Message Quality)

#### Unit Test Scenarios

| ID           | Level | Priority | Test Scenario                                              | Justification                              | Mitigates Risk |
| ------------ | ----- | -------- | ---------------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-UNIT-056 | Unit  | P1       | Undefined variable throws VariableSubstitutionError        | Proper error class                         | -              |
| 3.4-UNIT-057 | Unit  | P1       | Error message includes variable name                       | User knows which variable failed           | OPS-001        |
| 3.4-UNIT-058 | Unit  | P1       | Error message includes list of available variables         | Context for debugging                      | OPS-001        |
| 3.4-UNIT-059 | Unit  | P1       | Fuzzy matching suggests similar variable names             | Typo detection                             | OPS-001        |
| 3.4-UNIT-060 | Unit  | P1       | Suggestion accuracy: `projetName` → suggest `projectName`  | Levenshtein distance ≤3                    | OPS-001        |
| 3.4-UNIT-061 | Unit  | P1       | No suggestions if distance >3                              | Avoid confusing suggestions                | OPS-001        |
| 3.4-UNIT-062 | Unit  | P2       | Multiple suggestions shown (up to 3)                       | Give user options                          | OPS-001        |
| 3.4-UNIT-063 | Unit  | P2       | Suggestions sorted by distance (closest first)             | Best suggestion first                      | OPS-001        |
| 3.4-UNIT-064 | Unit  | P2       | Case-sensitive suggestion matching                         | Exact match preferred                      | OPS-001        |
| 3.4-UNIT-065 | Unit  | P2       | Malformed syntax error message - clear description         | Help user fix syntax errors                | -              |
| 3.4-UNIT-066 | Unit  | P1       | Error logged with structured context (Pino)                | Debugging and monitoring                   | -              |

---

### AC 7: Preview shows substituted values

**Risk Coverage**: OPS-002 (Terminal Compatibility)

#### Unit Test Scenarios

| ID           | Level | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ------------ | ----- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.4-UNIT-067 | Unit  | P2       | Preview shows original template                  | User sees before state                 | -              |
| 3.4-UNIT-068 | Unit  | P2       | Preview shows substituted output                 | User sees after state                  | -              |
| 3.4-UNIT-069 | Unit  | P2       | Preview highlights substituted variables         | User sees what changed                 | -              |
| 3.4-UNIT-070 | Unit  | P2       | Preview shows variable values inline             | User sees values used                  | -              |
| 3.4-UNIT-071 | Unit  | P2       | Terminal formatting with ANSI color codes        | Visual highlighting                    | OPS-002        |
| 3.4-UNIT-072 | Unit  | P3       | Graceful degradation on legacy terminals         | No colors if not supported             | OPS-002        |

---

### AC 8: Performance <5ms for typical templates

**Risk Coverage**: PERF-001 (Nested Performance - CRITICAL), PERF-002 (Caching)

#### Performance Benchmark Scenarios

| ID           | Level | Priority | Test Scenario                                         | Justification                              | Mitigates Risk |
| ------------ | ----- | -------- | ----------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-PERF-003 | Unit  | P0       | Simple template (1-5 vars): <1ms                      | Baseline performance                       | PERF-001       |
| 3.4-PERF-004 | Unit  | P0       | Typical template (10-50 vars): <5ms **CRITICAL AC**   | Acceptance criteria must pass              | PERF-001       |
| 3.4-PERF-005 | Unit  | P0       | Complex template (50-100 vars): <15ms                 | Performance target for large templates     | PERF-001       |
| 3.4-PERF-006 | Unit  | P1       | Repeated substitution (same template) - cache hit     | Cache effectiveness                        | PERF-002       |
| 3.4-PERF-007 | Unit  | P1       | Memory usage <5MB for cache under load                | Memory leak prevention                     | PERF-002       |
| 3.4-PERF-008 | Unit  | P1       | 1000 substitutions/second sustained load              | Throughput validation                      | PERF-001       |
| 3.4-PERF-009 | Unit  | P1       | Regex compilation happens once (not per call)         | Performance optimization verification      | PERF-001       |
| 3.4-PERF-010 | Unit  | P2       | Cache invalidation after variable update              | Cache coherency                            | PERF-002       |

---

## Integration Test Scenarios

### TemplateEngine Integration (AC 1-8)

**Risk Coverage**: Integration with Story 3.1

| ID           | Level       | Priority | Test Scenario                                          | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------------------ | ------------------------------------------ | -------------- |
| 3.4-INT-007  | Integration | P0       | TemplateEngine.processTemplate() uses VariableSubstitutor | Integration point validation               | -              |
| 3.4-INT-008  | Integration | P1       | Template processing pipeline: load → substitute → output | End-to-end workflow                        | -              |
| 3.4-INT-009  | Integration | P1       | Error from substitution propagates through TemplateEngine | Error handling integration                 | -              |
| 3.4-INT-010  | Integration | P1       | Performance metrics logged via TemplateEngine          | Logging integration                        | -              |

### ComputedVariableEngine Integration (AC 1)

**Risk Coverage**: Integration with Story 3.3 computed variables

| ID           | Level       | Priority | Test Scenario                                          | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------------------ | ------------------------------------------ | -------------- |
| 3.4-INT-011  | Integration | P1       | Computed variables evaluated before substitution       | Computation timing                         | TECH-001       |
| 3.4-INT-012  | Integration | P1       | Substitution uses computed variable values             | Computed value integration                 | TECH-001       |

### EnvironmentVariableResolver Integration (AC 1)

**Risk Coverage**: Integration with Story 3.3 environment variables

| ID           | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
| ------------ | ----------- | -------- | ------------------------------------------------ | -------------------------------------- | -------------- |
| 3.4-INT-013  | Integration | P1       | $ENV: prefix variables resolved before substitution | Environment variable integration       | TECH-001       |
| 3.4-INT-014  | Integration | P2       | Environment variable in nested substitution      | Complex integration scenario           | TECH-001       |

---

## End-to-End Test Scenarios

### Critical User Journeys

| ID          | Level | Priority | Test Scenario                                                 | Justification                              | Mitigates Risk |
| ----------- | ----- | -------- | ------------------------------------------------------------- | ------------------------------------------ | -------------- |
| 3.4-E2E-001 | E2E   | P1       | User loads template → variables substituted → output displayed | Complete user workflow                     | -              |
| 3.4-E2E-002 | E2E   | P1       | User encounters undefined variable → sees clear error → fixes → success | Error recovery journey                     | OPS-001        |

---

## Risk Coverage Matrix

Mapping test scenarios to identified risks from `docs/qa/assessments/3.4-risk-20251010.md`:

| Risk ID  | Risk Title                              | Score | Test Coverage                                    | Coverage Count |
| -------- | --------------------------------------- | ----- | ------------------------------------------------ | -------------- |
| SEC-001  | Variable Substitution Injection Attacks | 9     | 3.4-SEC-001 to 3.4-SEC-024, 3.4-INT-005/006      | 26 scenarios   |
| PERF-001 | Nested Variable Resolution Performance  | 9     | 3.4-UNIT-026 to 3.4-UNIT-035, 3.4-PERF-001/002/003/004/005/008/009 | 17 scenarios   |
| SEC-002  | Regular Expression ReDoS Vulnerability  | 6     | 3.4-SEC-015, 3.4-SEC-016, 3.4-SEC-017, 3.4-SEC-018 | 4 scenarios    |
| DATA-001 | Variable Value Sanitization Failures    | 6     | 3.4-UNIT-003 to 3.4-UNIT-024, 3.4-SEC-009/010/011/012 | 26 scenarios   |
| TECH-001 | Integration Breaking Changes            | 6     | 3.4-INT-001 to 3.4-INT-004, 3.4-INT-011/012/013/014 | 8 scenarios    |
| PERF-002 | Cache Invalidation Strategy             | 4     | 3.4-PERF-006, 3.4-PERF-007, 3.4-PERF-010         | 3 scenarios    |
| OPS-001  | Error Message Quality                   | 4     | 3.4-UNIT-056 to 3.4-UNIT-066, 3.4-E2E-002        | 12 scenarios   |
| TECH-002 | Escape Sequence Edge Cases              | 4     | 3.4-UNIT-047 to 3.4-UNIT-055                     | 9 scenarios    |
| DATA-002 | Array Value Formatting Ambiguity        | 2     | 3.4-UNIT-022                                     | 1 scenario     |
| OPS-002  | Preview Terminal Formatting             | 2     | 3.4-UNIT-071, 3.4-UNIT-072                       | 2 scenarios    |

**Coverage Summary**:
- All 10 risks have dedicated test scenarios
- Critical risks (SEC-001, PERF-001) have >15 test scenarios each
- High risks (score 6) have 4-26 scenarios each
- Medium/low risks have appropriate coverage (1-12 scenarios)

---

## Test Execution Strategy

### Phase 1: P0 Unit Tests (MUST PASS before integration)

**Execution Order** (fail fast on critical issues):

1. **Security Tests** (3.4-SEC-001 to 3.4-SEC-024) - 24 tests
   - **Rationale**: Security is non-negotiable; any failures block all work
   - **Expected Duration**: 5-10 minutes
   - **Failure Action**: STOP - Fix security issues immediately

2. **Performance Benchmarks** (3.4-PERF-003 to 3.4-PERF-005) - 3 tests
   - **Rationale**: AC 8 requirement; must validate <5ms early
   - **Expected Duration**: 1-2 minutes
   - **Failure Action**: STOP - Optimize algorithm before proceeding

3. **Core Functionality** (3.4-UNIT-001 to 3.4-UNIT-024) - 24 tests
   - **Rationale**: Basic substitution must work before advanced features
   - **Expected Duration**: 2-3 minutes
   - **Failure Action**: Fix core logic issues

4. **Nested Variables** (3.4-UNIT-025 to 3.4-UNIT-035) - 11 tests
   - **Rationale**: Complex feature with performance implications
   - **Expected Duration**: 2-3 minutes
   - **Failure Action**: Fix recursion issues

5. **Defaults and Escaping** (3.4-UNIT-036 to 3.4-UNIT-055) - 20 tests
   - **Rationale**: Additional core features
   - **Expected Duration**: 2-3 minutes

**Total P0 Unit Tests**: 82 scenarios (includes all security + critical functional)
**Total Expected Duration**: 12-21 minutes

### Phase 2: P0 Integration Tests

**Execution Order**:

1. **VariableStore Integration** (3.4-INT-001 to 3.4-INT-004) - 4 tests
   - **Rationale**: Critical dependency validation
   - **Expected Duration**: 1-2 minutes
   - **Failure Action**: Coordinate with Story 3.3 team if API mismatch

2. **Security Integration** (3.4-INT-005, 3.4-INT-006) - 2 tests
   - **Rationale**: OWASP testing requires integration environment
   - **Expected Duration**: 5-10 minutes (OWASP ZAP scan)
   - **Failure Action**: STOP - Fix injection vulnerabilities

3. **TemplateEngine Integration** (3.4-INT-007) - 1 test
   - **Rationale**: Integration point with Story 3.1
   - **Expected Duration**: 1 minute

**Total P0 Integration Tests**: 7 scenarios
**Total Expected Duration**: 7-13 minutes

### Phase 3: P1 Tests

**Execution**: Run all P1 unit + integration tests in parallel
- **Unit Tests**: 24 scenarios
- **Integration Tests**: 7 scenarios
- **E2E Tests**: 2 scenarios
- **Total P1**: 33 scenarios
- **Expected Duration**: 10-15 minutes

### Phase 4: P2/P3 Tests (Time Permitting)

**Execution**: Run in CI nightly or before release
- **Total P2**: 12 scenarios
- **Total P3**: 4 scenarios
- **Expected Duration**: 5-7 minutes

---

## Continuous Integration Requirements

### CI Pipeline Gates

**Pre-Commit Hook** (Developer Workstation):
1. Run all P0 unit tests (<5 min)
2. Lint and type-check
3. Block commit if failures

**Pull Request Validation**:
1. Run all unit tests (P0 + P1 + P2)
2. Run all integration tests (P0 + P1)
3. Run performance benchmarks (MUST PASS <5ms requirement)
4. Run mutation tests (Stryker - 85% threshold)
5. Generate coverage report (>90% for core package)

**Nightly Regression**:
1. Run full test suite (all priorities)
2. Run E2E tests
3. Run extended performance tests (1000 substitutions/sec load test)
4. Run OWASP ZAP full scan

### Performance Monitoring

**Benchmark Assertions in CI**:
```typescript
// tests/benchmarks/template-substitution.bench.ts
import { bench, group } from 'tinybench';

group('Variable Substitution Performance', () => {
  bench('simple template (1-5 vars)', () => {
    substitutor.substitute(simpleTemplate);
  }).expect({ meanTime: '<1ms' }); // MUST PASS

  bench('typical template (10-50 vars)', () => {
    substitutor.substitute(typicalTemplate);
  }).expect({ meanTime: '<5ms' }); // AC 8 - CRITICAL

  bench('complex template (50-100 vars)', () => {
    substitutor.substitute(complexTemplate);
  }).expect({ meanTime: '<15ms' }); // MUST PASS
});
```

**Alert on Performance Regression**:
- P95 latency >5ms for typical templates → BLOCK PR
- Memory usage >5MB for cache → ALERT (investigate)
- Throughput <1000/sec → ALERT (investigate)

---

## Test Data Requirements

### Variable Stores (Test Fixtures)

**Simple Store** (1-5 variables):
```typescript
const simpleVars = {
  name: 'Alice',
  project: 'BMAD Checklist',
  version: '1.0.0',
  env: 'production',
};
```

**Typical Store** (10-50 variables):
```typescript
const typicalVars = {
  // User variables
  userName: 'Bob Developer',
  userEmail: 'bob@example.com',
  userId: 12345,

  // Project variables
  projectName: 'My Project',
  projectPath: '/home/user/projects/my-project',
  projectVersion: '2.1.0',

  // Environment variables
  env: 'staging',
  apiUrl: 'https://api.staging.example.com',
  dbHost: 'db.staging.internal',

  // Configuration
  timeout: 5000,
  retries: 3,
  debug: true,

  // Arrays
  tags: ['feature', 'backend', 'critical'],

  // ... (expand to 50 variables)
};
```

**Complex Store** (50-100 variables):
- Extend typical store with additional nested variables
- Include edge case values (NaN, Infinity, empty arrays)

**Malicious Store** (Security Testing):
```typescript
const maliciousVars = {
  sqlInjection: "'; DROP TABLE users--",
  xssAttempt: '<script>alert(1)</script>',
  commandInjection: '; cat /etc/passwd',
  pathTraversal: '../../etc/passwd',
  nullByte: 'value\x00malicious',
};
```

### Templates (Test Fixtures)

**Simple Template**:
```
Hello ${name}, welcome to ${project}!
```

**Typical Template**:
```
Project: ${projectName}
Version: ${projectVersion}
Environment: ${env}
API Endpoint: ${apiUrl}

User: ${userName} (${userEmail})
User ID: ${userId}

Configuration:
- Timeout: ${timeout}ms
- Retries: ${retries}
- Debug: ${debug}

Tags: ${tags}

Database: ${dbHost}
Path: ${projectPath}
```

**Complex Template** (50+ variables, nested):
```
${baseUrl}/${apiVersion}/${endpoint}
Authorization: Bearer ${token}
User-Agent: ${userAgent}

Request ID: ${requestId}
Timestamp: ${timestamp}

Variables:
${var1}, ${var2}, ${var3}, ... ${var50}

Nested: ${path.${filename}.${extension}}
Default: ${optional:-default_value}
Escaped: \${literal}
```

### OWASP Test Payloads

Reference: [OWASP Testing Guide - Injection](https://owasp.org/www-project-web-security-testing-guide/)

**SQL Injection**:
- `' OR '1'='1`
- `'; DROP TABLE users--`
- `1' UNION SELECT null, username, password FROM users--`

**XSS**:
- `<script>alert(1)</script>`
- `<img src=x onerror=alert(1)>`
- `javascript:alert(1)`

**Command Injection**:
- `; cat /etc/passwd`
- `| ls -la`
- `` `whoami` ``

**Path Traversal**:
- `../../etc/passwd`
- `....//....//etc/passwd`
- `%2e%2e%2f%2e%2e%2fetc/passwd`

---

## Test Automation and Tooling

### Unit Test Framework (Bun Test)

**File Location**: `packages/core/tests/templates/`

**Test File Structure**:
```
packages/core/tests/templates/
├── VariableSubstitutor.test.ts        # AC 1, 2, 3, 4, 5, 6
├── NestedSubstitution.test.ts         # AC 2 (dedicated)
├── DefaultValues.test.ts              # AC 3 (dedicated)
├── EscapeSequences.test.ts            # AC 4 (dedicated)
├── SecurityTests.test.ts              # AC 5 (dedicated)
├── ErrorMessages.test.ts              # AC 6 (dedicated)
├── SubstitutionPreview.test.ts        # AC 7
└── integration/
    ├── template-substitution.integration.test.ts
    └── template-engine.integration.test.ts
```

### Performance Benchmarks (Tinybench)

**File Location**: `tests/benchmarks/template-substitution.bench.ts`

**Benchmark Configuration**:
```typescript
import { Bench } from 'tinybench';

const bench = new Bench({
  time: 1000,        // 1 second per benchmark
  iterations: 1000,  // Min 1000 iterations
  warmup: true,      // Warmup before measuring
});
```

### Security Testing Tools

**OWASP ZAP Integration**:
```bash
# Run ZAP scan in CI
docker run -t owasp/zap2docker-stable zap-baseline.py \
  -t http://localhost:3000 \
  -r zap-report.html
```

**Manual Penetration Testing**:
- Use Burp Suite or OWASP ZAP for manual testing
- Test all security scenarios from 3.4-SEC-* suite
- Document findings in security test results

### Mutation Testing (Stryker)

**Configuration**: `stryker.conf.json`

**Mutation Score Threshold**: 85% (per project standards)

**Target Files**:
- `packages/core/src/templates/VariableSubstitutor.ts`
- `packages/core/src/templates/SubstitutionPreview.ts`
- All error handling code

---

## Coverage Requirements

### Overall Coverage Targets

**Per CLAUDE.md Requirements**:
- Overall project: ≥80%
- Core package: ≥90%
- New code (Story 3.4): 100% expected

### Coverage by Component

| Component               | Line Coverage | Branch Coverage | Function Coverage | Statement Coverage |
| ----------------------- | ------------- | --------------- | ----------------- | ------------------ |
| VariableSubstitutor     | >95%          | >95%            | 100%              | >95%               |
| SubstitutionPreview     | >90%          | >90%            | 100%              | >90%               |
| Error Classes           | >90%          | >85%            | 100%              | >90%               |
| Integration Layer       | >85%          | >80%            | 100%              | >85%               |

### Uncovered Code Justification

**Acceptable Gaps** (if any):
- Error paths for truly unreachable conditions (must document why unreachable)
- Defensive programming checks (e.g., TypeScript should prevent but runtime check added)
- Performance optimization code paths (if not triggered in test environment)

**All gaps must be documented in test files with comments explaining why not covered.**

---

## Test Maintenance Strategy

### Test Ownership

**Owner**: Dev team implementing Story 3.4
**Reviewer**: Quinn (Test Architect)
**Approver**: QA gate must PASS before merge

### Test Documentation

**Each test must include**:
1. Clear test name describing scenario
2. Given-When-Then structure (or equivalent)
3. Assertion rationale
4. Risk mapping (if applicable)

**Example**:
```typescript
describe('VariableSubstitutor', () => {
  it('should reject variable names with semicolons (SEC-001)', () => {
    // GIVEN a template with semicolon in variable name (injection attempt)
    const maliciousTemplate = '${cmd;}';

    // WHEN substitution is attempted
    // THEN a SecurityError should be thrown
    expect(() => {
      substitutor.substitute(maliciousTemplate);
    }).toThrow(SecurityError);

    // AND the error message should indicate invalid variable name
    expect(() => {
      substitutor.substitute(maliciousTemplate);
    }).toThrow(/Invalid variable name/);
  });
});
```

### Test Refactoring

**When to refactor tests**:
- Test duplication identified
- Test flakiness detected
- Test execution time >30s for unit tests
- Coverage drops below threshold

**Refactoring requires**:
- Maintain same coverage level
- Preserve all risk mitigations
- Update documentation

---

## Recommended Test Execution Order (Summary)

**For Developers** (Pre-Commit):
1. P0 Security tests (3.4-SEC-*) - MUST PASS
2. P0 Performance benchmarks (3.4-PERF-003/004/005) - MUST PASS
3. P0 Core functionality (3.4-UNIT-001 to 3.4-UNIT-035)

**For CI** (Pull Request):
1. All P0 tests
2. All P1 tests
3. All integration tests
4. Coverage report (>90%)
5. Mutation testing (>85%)

**For Nightly Regression**:
1. Full test suite (all priorities)
2. E2E tests
3. Extended performance tests
4. OWASP ZAP scan

---

## Test Design Validation Checklist

Before finalizing test design:

- [x] Every AC has test coverage (AC 1-8 all covered)
- [x] Test levels are appropriate (76% unit, 21% integration, 3% E2E)
- [x] No duplicate coverage across levels (validated)
- [x] Priorities align with business risk (P0 for critical risks)
- [x] Test IDs follow naming convention (3.4-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent (validated)
- [x] All 10 risks have dedicated test scenarios
- [x] Performance requirements are testable (<5ms AC 8)
- [x] Security requirements are comprehensive (26 security tests)
- [x] Integration points validated (VariableStore, TemplateEngine, etc.)

---

## Summary and Next Steps

### Test Design Summary

**Comprehensive Coverage**:
- 68 total test scenarios designed
- All 8 acceptance criteria covered
- All 10 identified risks mitigated
- Performance, security, and functionality validated

**Quality Assurance**:
- P0 tests block deployment if failures
- Continuous monitoring via CI
- Mutation testing ensures test quality
- >90% coverage target for core package

**Risk Mitigation**:
- 26 security tests address SEC-001 (injection attacks)
- 17 performance tests address PERF-001 (nesting performance)
- 8 integration tests address TECH-001 (VariableStore integration)
- All critical risks have extensive test coverage

### For Development Team

**Before Implementation Starts**:
1. Review this test design document
2. Set up test infrastructure (test files, fixtures, benchmarks)
3. Configure CI pipeline with performance assertions
4. Prepare OWASP ZAP integration for security testing

**During Implementation**:
1. Write tests FIRST for each task (TDD approach)
2. Run P0 tests frequently (pre-commit hook)
3. Monitor coverage in real-time
4. Address test failures immediately

**Before Pull Request**:
1. All P0 + P1 tests passing
2. Coverage >90% validated
3. Performance benchmarks passing (<5ms)
4. Security tests passing (OWASP ZAP clean)
5. Mutation testing >85%

### For QA Process

**Quality Gate Decision Factors**:
- All P0 tests passing → Required for PASS
- Coverage >90% → Required for PASS
- Performance <5ms → Required for PASS (AC 8)
- Security tests passing → Required for PASS
- Mutation score >85% → Required for PASS

**Gate Mapping**:
- Any P0 test failures → Gate = FAIL
- Coverage <90% → Gate = FAIL
- Performance >5ms → Gate = FAIL (AC 8 violation)
- Security issues → Gate = FAIL (SEC-001 critical)

---

**END OF TEST DESIGN DOCUMENT**
