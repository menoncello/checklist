# Risk Profile: Story 3.3 - Variable Management System

**Date**: 2025-10-10
**Reviewer**: Quinn (Test Architect)
**Story ID**: 3.3
**Story Title**: Variable Management System

---

## Executive Summary

- **Total Risks Identified**: 13
- **Critical Risks (Score 9)**: 2
- **High Risks (Score 6)**: 3
- **Medium Risks (Score 4)**: 4
- **Low Risks (Score 2)**: 4
- **Overall Story Risk Score**: **2/100** (High Risk)

### Risk Verdict

This story presents **HIGH RISK** requiring mandatory mitigation before production deployment. The primary concerns are:

1. **Security**: Computed expression sandbox escape (SEC-001) poses catastrophic risk
2. **Reliability**: Circular dependency detection (DATA-003) critical for system stability
3. **Integration**: Undefined TUI integration (TECH-002) blocks feature completion

**Recommendation**: Proceed with implementation but apply rigorous security controls and comprehensive testing. All critical risks must be addressed before code review.

---

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Computed Expression Sandbox Escape

**Score: 9 (Critical)**
**Category**: Security
**Affected Components**: ComputedVariableEngine, TemplateSandbox

**Probability**: High (3)
Given the complexity of JavaScript expression evaluation and the requirement to support arithmetic, string interpolation, boolean logic, and comparison operators, the attack surface is substantial. History shows sandbox escapes are common in expression evaluators.

**Impact**: High (3)
Successful sandbox escape would allow arbitrary code execution with full application privileges, enabling:
- File system access (read sensitive data, modify state files)
- Network access (exfiltrate data)
- Process manipulation (crash application, spawn child processes)
- Privilege escalation

**Mitigation Strategy**: Preventive

**Required Actions**:
1. Use isolated VM context (Bun's `vm` module) with strict function allowlist
2. Disable all dangerous capabilities:
   - `require()`, `import()` (module loading)
   - `Bun`, `process` (runtime access)
   - Filesystem APIs (`Bun.file()`, `Bun.write()`)
   - Network APIs (`fetch`, `WebSocket`)
3. Implement AST (Abstract Syntax Tree) parsing to validate expressions **before** evaluation
4. Enforce hard timeout (5000ms) and memory limit (10MB) with forced termination
5. Add comprehensive fuzzing test suite with 10,000+ malicious payloads

**Testing Requirements**:
- **Security Penetration Testing**: Use OWASP payload library for injection attacks
- **Fuzzing**: Generate malicious expressions targeting known escape vectors
- **Unit Tests**: Verify every blocked capability throws SecurityError
- **Integration Tests**: End-to-end computed variable evaluation with malicious inputs

**Residual Risk**: Low
Zero-day VM escape vulnerabilities are possible but rare in mature runtimes. Layered defense (AST parsing + VM isolation + resource limits) provides defense in depth.

**Owner**: Dev Team (Task 6: ComputedVariableEngine)
**Timeline**: Must complete before Task 6 code review

---

### 2. DATA-003: Circular Dependency Infinite Loop

**Score: 9 (Critical)**
**Category**: Data
**Affected Components**: ComputedVariableEngine

**Probability**: High (3)
Circular dependency detection is algorithmically complex, especially with deep dependency chains. Easy to introduce bugs in visited set tracking, and the story spec shows implementation as a stub (`// Recursively check dependencies` comment at line 414).

**Impact**: High (3)
Undetected circular dependencies cause infinite loops, leading to:
- Application hang (user's terminal freezes)
- Watchdog timeout and crash
- Resource exhaustion (memory/CPU)
- Data loss if crash occurs during state save
- Poor user experience (requires force quit)

**Mitigation Strategy**: Preventive + Detective

**Required Actions**:
1. Implement **correct** DFS-based cycle detection algorithm:
   ```typescript
   private detectCircularDependencies(
     varName: string,
     dependencies: string[],
     visited: Set<string> = new Set(),
     path: string[] = []
   ): void {
     if (visited.has(varName)) {
       throw new CircularDependencyError(
         `Circular dependency: ${path.join(' → ')} → ${varName}`
       );
     }
     visited.add(varName);
     path.push(varName);

     for (const dep of dependencies) {
       const depDefinition = this.getDefinition(dep);
       if (depDefinition?.computed) {
         this.detectCircularDependencies(
           dep,
           depDefinition.computed.dependencies,
           visited,
           path
         );
       }
     }

     visited.delete(varName);
     path.pop();
   }
   ```
2. Add recursion depth limit (max 50 levels) as backstop
3. Validate dependency graph during template parse (fail fast)
4. Add watchdog timer (5000ms max) with forced termination
5. Comprehensive unit tests with intentional circular patterns

**Testing Requirements**:
- **Unit Tests**: All circular patterns:
  - Direct self-reference: `A → A`
  - Two-node cycle: `A → B → A`
  - Three-node cycle: `A → B → C → A`
  - Complex cycle: `A → B → C → D → B`
- **Integration Tests**: Large dependency graphs (100+ variables)
- **Performance Tests**: Verify detection completes in <5ms

**Residual Risk**: Minimal
DFS cycle detection is well-established algorithm with known correctness properties.

**Owner**: Dev Team (Task 6: ComputedVariableEngine)
**Timeline**: Must complete before Task 6 code review

---

## High Risks

### 3. SEC-002: Environment Variable Exposure

**Score: 6 (High)**
**Category**: Security
**Affected Components**: EnvironmentVariableResolver

**Probability**: Medium (2)
Allowlist maintenance is manual and error-prone. Developers may inadvertently add dangerous variables. Default allowlist (HOME, USER, PATH, PWD, SHELL, LANG, TERM) is safe, but risk emerges if expanded.

**Impact**: High (3)
Exposure of sensitive environment variables would leak:
- API keys (`AWS_SECRET_KEY`, `GITHUB_TOKEN`)
- Database credentials (`DATABASE_PASSWORD`, `DB_CONNECTION_STRING`)
- Encryption keys (`ENCRYPTION_KEY`)
- OAuth secrets (`OAUTH_CLIENT_SECRET`)

This could lead to unauthorized access to external services, data breaches, or account compromise.

**Mitigation Strategy**: Preventive + Detective

**Actions**:
1. Maintain **minimal** allowlist (only 7 safe variables)
2. Implement pattern-based blocking (deny if name contains):
   - `KEY`, `SECRET`, `TOKEN`, `PASSWORD`, `API`, `AUTH`, `CREDENTIAL`
3. Add audit logging for **all** environment variable access (allowed + denied)
4. Require explicit user confirmation on first-time env var access
5. Provide clear error messages explaining security boundaries

**Testing Requirements**:
- Security tests attempting to access: `AWS_SECRET_KEY`, `DATABASE_PASSWORD`, `GITHUB_TOKEN`, etc.
- Unit tests verifying allowlist enforcement
- Integration tests validating audit log output

**Residual Risk**: Low
Some legitimate variables may share naming patterns (e.g., `MY_API_URL` blocked despite being non-sensitive).

**Timeline**: Before Task 5 (EnvironmentVariableResolver)

---

### 4. DATA-001: Variable State Corruption

**Score: 6 (High)**
**Category**: Data
**Affected Components**: VariableStore (persistence layer)

**Probability**: Medium (2)
Concurrent access patterns not clearly specified in story. Risk of:
- Multiple processes/instances writing simultaneously
- Power loss during write
- Filesystem errors (disk full, permission denied)

**Impact**: High (3)
State corruption leads to:
- Loss of all user-defined variables
- Workflow instance becomes unusable
- User must re-enter all variable values
- Potential cascade failure if corrupted state loaded

**Mitigation Strategy**: Preventive

**Actions**:
1. Implement **atomic file writes**:
   ```typescript
   async persist(): Promise<void> {
     const tmpFile = `${this.stateFile}.tmp`;
     await Bun.write(tmpFile, yaml.dump(stateData));
     await fsync(tmpFile); // Ensure data on disk
     await rename(tmpFile, this.stateFile); // Atomic operation
   }
   ```
2. Create automatic backup before every save (`state.yaml.backup`)
3. Add Ajv schema validation on load (detect corruption early)
4. Implement file locking (use `proper-lockfile` library) to prevent concurrent writes
5. Add corruption recovery: attempt backup load on parse failure

**Testing Requirements**:
- Integration tests: Concurrent save operations (race conditions)
- Chaos tests: Simulate power loss during write (terminate process mid-operation)
- Unit tests: Backup creation and recovery paths

**Residual Risk**: Low
Atomic renames are OS-guaranteed on POSIX systems (Linux, macOS).

**Timeline**: Task 2 (VariableStore persistence)

---

### 5. TECH-002: Variable Prompting UX Integration

**Score: 6 (High)**
**Category**: Technical
**Affected Components**: VariablePrompter

**Probability**: High (3)
Story documentation explicitly states "implementation depends on UI layer" (line 512-514) and shows placeholder return:
```typescript
private async prompt(definition: VariableDefinition): Promise<VariableValue> {
  // Implementation depends on TUI layer
  // For now, return a placeholder
  return definition.default ?? '';
}
```

This is a **known gap** in the specification.

**Impact**: Medium (2)
Without TUI integration:
- Feature is incomplete and non-functional
- Cannot prompt users for required variables during `init`
- Blocks AC #2 ("Required variables prompted during init")
- Delays story completion and testing

**Mitigation Strategy**: Corrective (planning gap)

**Actions**:
1. Define TUI integration contract using **dependency injection**:
   ```typescript
   interface IPromptProvider {
     promptString(prompt: string, defaultValue?: string): Promise<string>;
     promptNumber(prompt: string, defaultValue?: number): Promise<number>;
     promptBoolean(prompt: string, defaultValue?: boolean): Promise<boolean>;
   }

   export class VariablePrompter {
     constructor(private promptProvider: IPromptProvider) {}
     // ...
   }
   ```
2. Implement `TUIPromptProvider` in TUI package using existing prompt components
3. Create `MockPromptProvider` for unit tests
4. Document prompting flow in architecture docs
5. Add integration tests for end-to-end prompting flow

**Testing Requirements**:
- Unit tests: VariablePrompter with MockPromptProvider
- Integration tests: Full `init` command flow with TUI prompts
- Manual testing: UX validation (prompt clarity, error messages)

**Residual Risk**: Minimal
Dependency injection pattern is well-established and testable.

**Owner**: Dev Team (requires coordination between Core and TUI packages)
**Timeline**: Must resolve before Task 4 can be completed

---

## Medium Risks

### 6. PERF-001: Computed Variable Evaluation Performance

**Score: 4 (Medium)**
**Category**: Performance
**Components**: ComputedVariableEngine

**Risk**: Complex computed expressions with deep dependency chains may exceed the 5ms performance target specified in story (line 572).

**Mitigation**:
- Implement LRU cache (max 1000 entries) for computed results
- Cache invalidation only on dependency changes (not full flush)
- Add performance benchmarks with target assertions
- Profile evaluation; optimize hot paths (consider JIT compilation)

**Testing**: Performance tests measuring evaluation time for expressions of varying complexity.

---

### 7. SEC-003: Variable Injection in Template Substitution

**Score: 4 (Medium)**
**Category**: Security
**Components**: TemplateEngine, VariableStore

**Risk**: Unvalidated variable values used in template substitution could enable injection attacks (XSS, command injection, path traversal).

**Mitigation**:
- Escape all variable values during substitution (HTML entities if applicable)
- Validate values against type schemas before substitution
- Use parameterized substitution (never string concatenation)
- Add validation for special characters in variable names (`$`, `{`, `}`, etc.)

**Testing**: Security tests injecting `<script>`, SQL fragments, shell commands (`; rm -rf /`).

---

### 8. TECH-001: Scope Resolution Complexity

**Score: 4 (Medium)**
**Category**: Technical
**Components**: VariableScopeManager

**Risk**: Step-level scope overriding global scope could lead to unexpected variable resolution, especially with nested steps or shadowing.

**Mitigation**:
- Implement clear resolution order: Step → Global (no complex inheritance)
- Add debug logging for scope resolution decisions
- Document algorithm with examples in user docs
- Add validation warnings for shadowed variables

**Testing**: Unit tests covering all scope scenarios (global, step, shadowing, nested).

---

### 9. TECH-003: TemplateSandbox Resource Limit Enforcement

**Score: 4 (Medium)**
**Category**: Technical
**Components**: ComputedVariableEngine, TemplateSandbox

**Risk**: Sandbox resource limits (5000ms timeout, 10MB memory) may not be properly enforced across all execution paths, allowing resource exhaustion.

**Mitigation**:
- Hard timeout using `setTimeout` + forced termination
- Track memory via `process.memoryUsage()` during evaluation
- Add watchdog process for sandbox execution
- Log all limit violations for security audit

**Testing**: Security tests with infinite loops, memory bombs (`'x'.repeat(1e9)`).

**Note**: Leverages existing TemplateSandbox infrastructure from Story 3.2.

---

## Low Risks

### 10. PERF-002: Variable Lookup Cache Invalidation (Score: 2)
**Mitigation**: Monitor cache hit rates; alert if <80%. Optimize invalidation to clear only affected entries.

### 11. DATA-002: Variable Type Coercion Loss (Score: 2)
**Mitigation**: Store type metadata in YAML; validate on load. Test edge cases (null, undefined, empty arrays).

### 12. OPS-001: Variable State Migration Path (Score: 2)
**Mitigation**: Initialize empty `variables: { global: {}, steps: {} }` if missing on load. Test with legacy state files.

### 13. OPS-002: Audit Logging Gaps (Score: 2)
**Mitigation**: Add structured Pino logging for all variable operations (get, set, evaluate, env access).

---

## Risk Distribution Analysis

### By Category

| Category      | Total Risks | Critical | High | Medium | Low |
|---------------|-------------|----------|------|--------|-----|
| Security      | 3           | 1        | 1    | 1      | 0   |
| Data          | 3           | 1        | 1    | 0      | 1   |
| Technical     | 3           | 0        | 1    | 2      | 0   |
| Performance   | 2           | 0        | 0    | 1      | 1   |
| Operational   | 2           | 0        | 0    | 0      | 2   |
| Business      | 0           | 0        | 0    | 0      | 0   |

**Insights**:
- **Security-heavy**: 3 security risks including 1 critical (sandbox escape)
- **Data integrity concerns**: 3 data risks including critical circular dependency issue
- **No business risks**: Story is purely technical infrastructure

### By Component

| Component                      | Risks | Highest Score |
|--------------------------------|-------|---------------|
| ComputedVariableEngine         | 4     | 9 (Critical)  |
| VariableStore                  | 3     | 6 (High)      |
| EnvironmentVariableResolver    | 1     | 6 (High)      |
| VariablePrompter               | 1     | 6 (High)      |
| TemplateSandbox                | 1     | 4 (Medium)    |
| VariableScopeManager           | 1     | 4 (Medium)    |
| TemplateEngine                 | 1     | 4 (Medium)    |

**Insights**:
- **ComputedVariableEngine is highest risk**: 4 risks including 2 critical
- **Task 6 requires extra scrutiny**: Focus testing and code review here
- **VariableStore is next hotspot**: 3 risks including data corruption

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Code Review)

**SEC-001 - Sandbox Escape Testing**:
- **Fuzzing Suite**: 10,000+ malicious expressions
  - Module loading attempts: `require('fs')`, `import('child_process')`
  - Runtime access: `Bun.file('/etc/passwd')`, `process.exit()`
  - Prototype pollution: `{}.__proto__.isAdmin = true`
  - Function constructor abuse: `new Function('return process')()`
- **OWASP Payload Library**: Inject known attack vectors
- **Resource Limit Violations**: Infinite loops, memory bombs
- **Expected Result**: All throw `SecurityError`, none succeed

**DATA-003 - Circular Dependency Testing**:
- **Unit Tests**: All circular patterns
  - Self-reference: `var A = { computed: { deps: ['A'] } }`
  - Two-node: `A → B → A`
  - Three-node: `A → B → C → A`
  - Complex: `A → B → C → D → B`
- **Integration Tests**: 100-variable dependency graph with embedded cycle
- **Performance Tests**: Detection completes in <5ms
- **Expected Result**: All throw `CircularDependencyError` with path

### Priority 2: High Risk Tests

**SEC-002 - Environment Variable Security**:
- Attempt access to `AWS_SECRET_KEY`, `DATABASE_PASSWORD`, `GITHUB_TOKEN`
- Verify allowlist enforcement (only 7 variables pass)
- Validate audit logging (all attempts logged)
- Test pattern blocking (`MY_API_KEY` denied)

**DATA-001 - State Corruption Prevention**:
- Concurrent save operations (5 simultaneous writes)
- Chaos test: Kill process mid-write, verify backup recovery
- Filesystem errors: Disk full, permission denied
- Corruption detection: Load invalid YAML, verify backup loaded

**TECH-002 - TUI Integration**:
- End-to-end `init` flow with required variables
- Validation retry logic (3 attempts)
- Default value handling
- Mock vs. real TUI prompt provider

### Priority 3: Medium Risk Tests

**PERF-001 - Performance Benchmarks**:
- Simple arithmetic: `a + b * c` (target <1ms)
- String interpolation: `` `${base}/${name}` `` (target <2ms)
- Complex nested: `(a + b) * (c / d) > threshold && enabled` (target <5ms)
- Large dependency chain: 10 levels deep (target <5ms)

**SEC-003 - Injection Prevention**:
- XSS: Variable value `<script>alert('xss')</script>`
- Command injection: `; rm -rf /`
- Path traversal: `../../../../etc/passwd`
- SQL injection: `' OR '1'='1`

**TECH-001 - Scope Resolution**:
- Global variable, no step override
- Step variable overriding global
- Nested steps (if applicable)
- Shadowing warnings

**TECH-003 - Resource Limits**:
- Timeout: `while(true) {}` (must kill at 5000ms)
- Memory: `'x'.repeat(1e9)` (must kill at 10MB)
- Watchdog: Verify forced termination

### Priority 4: Low Risk Tests

- Cache hit rate monitoring (PERF-002)
- Type serialization roundtrip (DATA-002)
- Legacy state migration (OPS-001)
- Audit log verification (OPS-002)

---

## Risk Acceptance Criteria

### Must Fix Before Production

**Blocking Issues** (Cannot deploy without resolution):
1. **SEC-001**: Implement sandbox isolation with AST validation
2. **DATA-003**: Implement correct circular dependency detection
3. **SEC-002**: Enforce minimal environment variable allowlist
4. **DATA-001**: Implement atomic writes with backup
5. **TECH-002**: Define and implement IPromptProvider interface

**Gate Decision**: These are **hard blockers**. Any failure → `FAIL` gate.

### Can Deploy with Mitigation

**Non-Blocking with Controls** (Deploy with monitoring/compensating controls):
- **Medium risks**: Can deploy if mitigations in place and documented
- **Low risks**: Can deploy with planned remediation

**Gate Decision**: `CONCERNS` gate with documented acceptance.

### Accepted Risks

**Explicitly Accepted** (Documented and signed off):
- **PERF-001**: Complex expressions may exceed 5ms (acceptable if <10ms)
- **OPS-002**: Incomplete audit logging (can enhance post-launch)

**Gate Decision**: `WAIVED` gate with rationale.

---

## Monitoring Requirements

### Post-Deployment Monitoring

**Performance Metrics** (for PERF risks):
- Variable lookup latency (p50, p95, p99)
- Computed variable evaluation time (p50, p95, p99)
- Cache hit rate (target >80%)

**Security Alerts** (for SEC risks):
- Sandbox security violations (count per hour)
- Environment variable access denials (by variable name)
- Template injection attempts (pattern matches)

**Error Rates** (for operational risks):
- Variable validation failures (by type)
- Circular dependency errors (count per day)
- State file corruption incidents (count per month)

**Business KPIs** (for future):
- Variable usage patterns (most common types)
- User-defined vs. computed variables ratio

### Alert Thresholds

- **Critical**: Sandbox security violation → Immediate page
- **High**: State corruption → Page within 15 minutes
- **Medium**: Performance degradation (>10ms) → Alert within 1 hour
- **Low**: Cache hit rate <80% → Alert within 24 hours

---

## Risk Review Triggers

**Re-evaluate risk profile when**:

1. **Architecture Changes**:
   - Switching to different sandbox implementation
   - Adding new variable types beyond string/number/boolean/array
   - Changing scope resolution algorithm

2. **New Integrations**:
   - Adding external data sources for variables
   - Integrating with secret management systems (Vault, AWS Secrets Manager)

3. **Security Events**:
   - Sandbox escape vulnerability discovered in Bun runtime
   - New injection attack vectors identified

4. **Performance Issues**:
   - Computed variable evaluation exceeding 10ms in production
   - Cache hit rate drops below 80%

5. **Regulatory Changes**:
   - New data privacy regulations (GDPR, CCPA)
   - Compliance requirements for audit logging

---

## Recommendations Summary

### For Development Team

1. **Prioritize Task 6 (ComputedVariableEngine)**: Highest risk component (2 critical, 2 medium)
2. **Security First**: Implement SEC-001 and DATA-003 mitigations before other tasks
3. **Define TUI Contract Early**: Resolve TECH-002 interface before Task 4
4. **Comprehensive Testing**: Target 95%+ coverage for ComputedVariableEngine and VariableStore
5. **Security Review**: Request external security audit for sandbox implementation

### For QA Team

1. **Fuzzing Infrastructure**: Set up automated fuzzing for computed expressions
2. **Chaos Testing**: Add chaos engineering tests for state corruption scenarios
3. **Performance Benchmarks**: Establish baseline before implementation starts
4. **Security Test Suite**: Prepare OWASP payload library for injection testing

### For Product Team

1. **Risk Communication**: Inform stakeholders of high-risk nature (2/100 score)
2. **Timeline Impact**: Expect additional time for security hardening
3. **Phased Rollout**: Consider beta release to limited users for risk mitigation
4. **Documentation**: Ensure user docs explain variable security boundaries

---

## Gate Mapping

Based on deterministic gate rules:

- **2 Critical Risks (Score 9)** → **Gate Decision: FAIL** (unless all mitigated)
- **3 High Risks (Score 6)** → **Gate Decision: CONCERNS** (if unresolved)

**Current Assessment**: Story will initially receive **FAIL** gate until SEC-001 and DATA-003 are fully implemented and tested. After critical risk mitigation, gate can be upgraded to **CONCERNS** while addressing high/medium risks.

---

## Conclusion

Story 3.3 (Variable Management System) is a **high-risk, high-complexity feature** requiring rigorous security controls and comprehensive testing. The primary risks stem from:

1. **Expression evaluation security** (sandbox escape)
2. **Dependency graph correctness** (circular dependencies)
3. **Data integrity** (state corruption, type safety)

**Recommendation**: Proceed with implementation using the mitigation strategies outlined in this risk profile. All critical risks must be addressed before code review. Comprehensive security testing and performance benchmarking are mandatory before production deployment.

**Risk Score**: 2/100 (High Risk)
**Estimated Risk Remediation Effort**: 30-40% of total story effort
**Recommended Gate Decision**: FAIL (until critical risks mitigated)

---

**Risk profile generated by**: Quinn (Test Architect)
**Profile version**: 1.0
**Next review**: After Task 6 (ComputedVariableEngine) implementation
