# Story 3.3: Dev Agent Quick Start Guide

**Story**: Variable Management System (v1.2 - Approved)
**Implementation Readiness**: 9/10 - HIGH Confidence
**Date**: 2025-10-10
**Prepared by**: Sarah (PO)

---

## üöÄ 5-Minute Quick Start

This guide gets you implementing in 5 minutes. For comprehensive checks, see `3.3-pre-implementation-checklist-20251010.md`.

---

## Step 1: Verify Environment (2 minutes)

```bash
# Check Bun version (should be 1.1.x+)
bun --version

# Verify quality checks pass
bun run quality

# Run existing tests
bun test

# Check branch
git status  # Should be on 3.3-conditional-logic or feature branch
```

**If all pass**: ‚úÖ Continue to Step 2
**If any fail**: ‚ùå Fix issues before proceeding

---

## Step 2: Verify Dependencies (2 minutes)

### Critical: Check Story 3.1/3.2 Artifacts

```bash
# Check if TemplateSandbox exists
ls packages/core/src/templates/TemplateSandbox.ts
# OR
ls packages/core/src/sandbox/TemplateSandbox.ts

# Check if TemplateEngine exists
ls packages/core/src/templates/TemplateEngine.ts
```

**If files exist**: ‚úÖ Continue to Step 3
**If files missing**: ‚ö†Ô∏è See "Dependency Fallback Plan" below

### Quick Dependency Check

Open these files and verify:
- **TemplateSandbox**: Has `evaluate()` method that accepts expression and context
- **TemplateEngine**: Has constructor and can be extended

---

## Step 3: Create Directory Structure (1 minute)

```bash
# Create source directories
mkdir -p packages/core/src/variables

# Create test directories
mkdir -p packages/core/tests/variables/integration

# Verify creation
ls -la packages/core/src/variables
ls -la packages/core/tests/variables
```

---

## Step 4: Start Implementation - Task 1 Foundation

### Create First File: `packages/core/src/variables/types.ts`

```typescript
// packages/core/src/variables/types.ts

/**
 * Variable value types supported by the system
 */
export type VariableValue = string | number | boolean | VariableValue[];

/**
 * Supported variable types
 */
export type VariableType = 'string' | 'number' | 'boolean' | 'array';

/**
 * Variable scope types
 */
export type VariableScope = 'global' | 'step';

/**
 * Variable validation rules
 */
export interface VariableValidation {
  /** Regex pattern for string validation */
  pattern?: string;
  /** Minimum value for numbers, minimum length for strings/arrays */
  min?: number;
  /** Maximum value for numbers, maximum length for strings/arrays */
  max?: number;
  /** Allowed values for enum validation */
  enum?: VariableValue[];
}

/**
 * Computed variable expression definition
 */
export interface ComputedExpression {
  /** JavaScript expression to evaluate */
  expression: string;
  /** Variable names this expression depends on */
  dependencies: string[];
}

/**
 * Variable definition with metadata
 */
export interface VariableDefinition {
  /** Variable name (unique identifier) */
  name: string;
  /** Variable type */
  type: VariableType;
  /** Whether variable is required */
  required: boolean;
  /** Default value if not provided */
  default?: VariableValue;
  /** Human-readable description */
  description: string;
  /** Optional validation rules */
  validation?: VariableValidation;
  /** Optional computed expression */
  computed?: ComputedExpression;
  /** Variable scope (default: global) */
  scope?: VariableScope;
}

/**
 * Validation result for variable values
 */
export interface ValidationResult {
  /** Whether validation passed */
  valid: boolean;
  /** Error message if validation failed */
  error?: string;
  /** Additional validation context */
  details?: Record<string, unknown>;
}
```

### Create Second File: `packages/core/src/variables/errors.ts`

```typescript
// packages/core/src/variables/errors.ts

/**
 * Base class for all variable-related errors
 */
export class VariableError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'VariableError';
  }
}

/**
 * Thrown when a required variable is not found
 */
export class VariableNotFoundError extends VariableError {
  constructor(variableName: string, scope?: string) {
    const scopeInfo = scope ? ` in scope '${scope}'` : '';
    super(`Variable '${variableName}' not found${scopeInfo}`);
    this.name = 'VariableNotFoundError';
  }
}

/**
 * Thrown when variable validation fails
 */
export class VariableValidationError extends VariableError {
  constructor(variableName: string, reason: string) {
    super(`Variable '${variableName}' validation failed: ${reason}`);
    this.name = 'VariableValidationError';
  }
}

/**
 * Thrown when circular dependencies are detected
 */
export class CircularDependencyError extends VariableError {
  constructor(dependencyChain: string) {
    super(`Circular dependency detected: ${dependencyChain}`);
    this.name = 'CircularDependencyError';
  }
}

/**
 * Thrown when environment variable access is denied
 */
export class EnvironmentVariableSecurityError extends VariableError {
  constructor(variableName: string) {
    super(
      `Access to environment variable '${variableName}' denied. Not in allowlist.`
    );
    this.name = 'EnvironmentVariableSecurityError';
  }
}

/**
 * Thrown when variable type mismatch occurs
 */
export class VariableTypeMismatchError extends VariableError {
  constructor(variableName: string, expected: string, actual: string) {
    super(
      `Variable '${variableName}' type mismatch: expected ${expected}, got ${actual}`
    );
    this.name = 'VariableTypeMismatchError';
  }
}

/**
 * Thrown when computed variable evaluation fails
 */
export class ComputedVariableEvaluationError extends VariableError {
  constructor(variableName: string, expression: string, reason: string) {
    super(
      `Computed variable '${variableName}' evaluation failed for expression '${expression}': ${reason}`
    );
    this.name = 'ComputedVariableEvaluationError';
  }
}

/**
 * Thrown when variable persistence fails
 */
export class VariablePersistenceError extends VariableError {
  constructor(reason: string) {
    super(`Variable persistence failed: ${reason}`);
    this.name = 'VariablePersistenceError';
  }
}
```

### Create Third File: `packages/core/src/variables/index.ts`

```typescript
// packages/core/src/variables/index.ts

/**
 * Variable Management System
 *
 * Provides flexible variable management with types, validation,
 * scoping, environment variables, and computed expressions.
 */

// Export types
export type {
  VariableValue,
  VariableType,
  VariableScope,
  VariableValidation,
  ComputedExpression,
  VariableDefinition,
  ValidationResult,
} from './types';

// Export errors
export {
  VariableError,
  VariableNotFoundError,
  VariableValidationError,
  CircularDependencyError,
  EnvironmentVariableSecurityError,
  VariableTypeMismatchError,
  ComputedVariableEvaluationError,
  VariablePersistenceError,
} from './errors';

// TODO: Export classes as they are implemented
// export { VariableStore } from './VariableStore';
// export { VariableScopeManager } from './VariableScopeManager';
// export { VariableValidator } from './VariableValidator';
// export { VariablePrompter } from './VariablePrompter';
// export { EnvironmentVariableResolver } from './EnvironmentVariableResolver';
// export { ComputedVariableEngine } from './ComputedVariableEngine';
```

---

## Step 5: Write Your First Test

### Create: `packages/core/tests/variables/types.test.ts`

```typescript
// packages/core/tests/variables/types.test.ts
import { describe, expect, test } from 'bun:test';
import type {
  VariableDefinition,
  VariableValidation,
  VariableValue,
} from '../../src/variables';

describe('Variable Types', () => {
  test('should allow valid variable values', () => {
    const stringValue: VariableValue = 'hello';
    const numberValue: VariableValue = 42;
    const booleanValue: VariableValue = true;
    const arrayValue: VariableValue = ['a', 'b', 'c'];

    expect(typeof stringValue).toBe('string');
    expect(typeof numberValue).toBe('number');
    expect(typeof booleanValue).toBe('boolean');
    expect(Array.isArray(arrayValue)).toBe(true);
  });

  test('should create valid variable definition', () => {
    const definition: VariableDefinition = {
      name: 'projectName',
      type: 'string',
      required: true,
      description: 'Project name',
      default: 'my-project',
      validation: {
        pattern: '^[a-z0-9-]+$',
        min: 3,
        max: 50,
      },
    };

    expect(definition.name).toBe('projectName');
    expect(definition.type).toBe('string');
    expect(definition.required).toBe(true);
  });
});
```

### Run the test

```bash
bun test packages/core/tests/variables/types.test.ts
```

**Expected**: ‚úÖ All tests pass

---

## Next Steps After Quick Start

### Immediate Next Steps (Task 1 Completion)

1. **Implement VariableValidator** (`packages/core/src/variables/VariableValidator.ts`)
   - Reference: Story lines 244-280
   - Test file: `packages/core/tests/variables/VariableValidator.test.ts`

2. **Run quality checks**:
   ```bash
   bun run quality
   ```

3. **Commit your progress**:
   ```bash
   git add packages/core/src/variables/
   git add packages/core/tests/variables/
   git commit -m "feat(story-3.3): Task 1 - Add variable types and errors"
   ```

### Task Progression Order

After completing Task 1:
- ‚úÖ **Task 2**: VariableStore (storage and persistence)
- ‚úÖ **Task 3**: VariableScopeManager (scoping)
- ‚úÖ **Task 4**: EnvironmentVariableResolver (env vars)
- ‚úÖ **Task 5**: VariablePrompter (prompting)
- ‚úÖ **Task 6**: ComputedVariableEngine (computed vars) - **Verify TemplateSandbox API first!**
- ‚úÖ **Task 7**: Integration (TemplateEngine integration)
- ‚úÖ **Task 8**: Testing (comprehensive test suite)

---

## Dependency Fallback Plan

### If TemplateSandbox is Missing

**Option 1: Implement Basic Sandbox**

Create minimal sandbox for Task 6:

```typescript
// packages/core/src/variables/BasicSandbox.ts
export class BasicSandbox {
  constructor(private config: { maxExecutionTime: number; maxMemory: number }) {}

  async evaluate(expression: string, context: Record<string, any>): Promise<any> {
    // Simple Function-based evaluation
    // WARNING: This is a placeholder - use TemplateSandbox from Story 3.1 for production
    try {
      const fn = new Function(...Object.keys(context), `return ${expression}`);
      return fn(...Object.values(context));
    } catch (error) {
      throw new Error(`Expression evaluation failed: ${error}`);
    }
  }
}
```

**Option 2: Defer Task 6**

- Complete Tasks 1-5 and 7 (skip Task 6)
- Note blocker in story completion notes
- Integrate ComputedVariableEngine when TemplateSandbox is available

### If TemplateEngine is Missing

**Defer Task 7 Integration**

- Complete Tasks 1-6
- Create integration points but don't modify TemplateEngine
- Document integration requirements for future story

---

## Performance Checkpoints

Run benchmarks after each major component:

```typescript
// Example benchmark for Task 2 (VariableStore)
import { bench, run } from 'tinybench';

const suite = new Bench({ time: 100 });

suite.add('variable lookup', () => {
  store.get('projectName');
});

await suite.run();

console.table(suite.table());
```

**Targets**:
- Variable lookup: <1ms
- Persistence: <10ms
- Computed evaluation: <5ms
- Scope resolution: <1ms

---

## Quality Check Commands

Run frequently during implementation:

```bash
# All quality checks
bun run quality

# Individual checks
bun run lint              # ESLint
bun run typecheck         # TypeScript
bun test                  # All tests
bun test:coverage         # Coverage report
```

**Requirements**:
- ‚úÖ No lint errors
- ‚úÖ No type errors
- ‚úÖ All tests passing
- ‚úÖ 90%+ coverage for core package

---

## Coding Standards Reminders

- üìè **File size**: Max 300 lines
- üìè **Function size**: Max 30 lines
- üìè **Complexity**: Max 10
- üìè **Constructor params**: Max 4 (use parameter objects)
- üö´ **No `any` types** without justification
- ‚úÖ **Use `??`** for nullish coalescing (not `||`)
- ‚úÖ **Use Bun APIs**: `Bun.env`, `Bun.file()`, `Bun.write()`

---

## Help & Resources

### Story Documentation
- **Full story**: `docs/stories/3.3.variable-management-system.story.md`
- **Pre-implementation checklist**: `docs/qa/assessments/3.3-pre-implementation-checklist-20251010.md`
- **This guide**: `docs/qa/assessments/3.3-quick-start-guide-20251010.md`

### Architecture References
- **Coding standards**: `docs/architecture/coding-standards.md`
- **Tech stack**: `docs/architecture/tech-stack.md`
- **Source tree**: `docs/architecture/source-tree.md`

### Getting Unstuck
1. Review story Dev Notes section (lines 107-632)
2. Check implementation examples in story
3. Review TestDataFactory examples (lines 729-821)
4. Consult pre-implementation checklist for risks/mitigation

---

## Success Indicators

You're on track when:
- ‚úÖ Tests written alongside code (TDD)
- ‚úÖ Quality checks passing after each task
- ‚úÖ Performance benchmarks meeting targets
- ‚úÖ Commits are small and focused
- ‚úÖ No blockers encountered or mitigation applied

---

## Ready, Set, Code! üöÄ

You now have:
- ‚úÖ Environment verified
- ‚úÖ Dependencies checked
- ‚úÖ Directory structure created
- ‚úÖ First three files created (types, errors, index)
- ‚úÖ First test written and passing

**Start implementing Task 1 (VariableValidator) and keep the momentum going!**

---

**Prepared by**: Sarah (PO Agent)
**For**: Dev Agent
**Story**: 3.3 Variable Management System v1.2
**Date**: 2025-10-10
